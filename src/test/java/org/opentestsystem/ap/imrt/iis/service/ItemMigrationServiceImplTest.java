package org.opentestsystem.ap.imrt.iis.service;

import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.runners.MockitoJUnitRunner;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.common.service.OperationalEventService;
import org.opentestsystem.ap.imrt.iis.builder.ItemGitInformationBuilder;
import org.opentestsystem.ap.imrt.iis.config.ItemIngestServiceProperties;
import org.opentestsystem.ap.imrt.iis.exception.GitLabApiRuntimeException;
import org.opentestsystem.ap.imrt.iis.model.ItemMigrationResponse;
import org.opentestsystem.ap.imrt.iis.repository.ItemGitInformationRepository;
import org.slf4j.Logger;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;

import java.util.Collections;

import static org.assertj.core.api.Java6Assertions.assertThat;
import static org.mockito.Matchers.any;
import static org.mockito.Matchers.anyString;
import static org.mockito.Matchers.anyVararg;
import static org.mockito.Matchers.isA;
import static org.mockito.Mockito.doNothing;
import static org.mockito.Mockito.doThrow;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.verifyZeroInteractions;
import static org.mockito.Mockito.when;

@RunWith(MockitoJUnitRunner.class)
public class ItemMigrationServiceImplTest {
    @Mock
    ItemIngestServiceProperties mockItemIngestServiceProperties;

    @Mock
    ItemGitInformationRepository mockItemGitInformationRepository;

    @Mock
    ItemUpdateNotificationHandler mockItemUpdateNotificationHandler;

    @Mock
    OperationalEventService mockOperationalEventService;

    @Mock
    Page<ItemGitInformation> mockItemGitInformationPage;


    ItemMigrationService itemMigrationService;

    @Before
    public void setup() {
        when(mockItemIngestServiceProperties.getImrtPageQueryLimit()).thenReturn(100);
        itemMigrationService = new ItemMigrationServiceImpl(mockItemGitInformationRepository,
                mockItemUpdateNotificationHandler,
                mockItemIngestServiceProperties,
                mockOperationalEventService);
    }

    @Test
    public void shouldMigrateItems() {
        final Pageable pageRequest = new PageRequest(0, mockItemIngestServiceProperties.getImrtPageQueryLimit());
        final ItemGitInformation itemGitInformation = new ItemGitInformationBuilder().build();

        when(mockItemGitInformationPage.getContent())
                .thenReturn(Collections.singletonList(itemGitInformation));
        when(mockItemGitInformationPage.hasNext()).thenReturn(false);
        when(mockItemGitInformationRepository.findAll(pageRequest))
                .thenReturn(mockItemGitInformationPage);
        doNothing().when(mockItemUpdateNotificationHandler).migrateItem(itemGitInformation);

        itemMigrationService.migrate();

        verify(mockItemGitInformationPage).getContent();
        verify(mockItemGitInformationPage).hasNext();
        verify(mockItemGitInformationRepository).findAll(pageRequest);
        verify(mockItemUpdateNotificationHandler).migrateItem(itemGitInformation);
    }

    @Test
    public void shouldMigrateMultiplePagesOfItems() {
        final Pageable pageRequest = new PageRequest(0, mockItemIngestServiceProperties.getImrtPageQueryLimit());
        final Pageable nextPageRequest = new PageRequest(1, mockItemIngestServiceProperties.getImrtPageQueryLimit());
        final ItemGitInformation itemGitInformation = new ItemGitInformationBuilder().build();

        when(mockItemGitInformationPage.getContent())
                .thenReturn(Collections.singletonList(itemGitInformation));
        when(mockItemGitInformationPage.hasNext())
                .thenReturn(true, false);
        when(mockItemGitInformationPage.nextPageable())
                .thenReturn(nextPageRequest);
        when(mockItemGitInformationRepository.findAll(isA(PageRequest.class)))
                .thenReturn(mockItemGitInformationPage);
        doNothing().when(mockItemUpdateNotificationHandler).migrateItem(itemGitInformation);

        final ItemMigrationResponse result = itemMigrationService.migrate();

        verify(mockItemGitInformationPage, times(2)).getContent();
        verify(mockItemGitInformationPage, times(2)).nextPageable();
        verify(mockItemGitInformationPage, times(2)).hasNext();
        verify(mockItemGitInformationRepository).findAll(pageRequest);
        verify(mockItemGitInformationRepository).findAll(nextPageRequest);
        verify(mockItemUpdateNotificationHandler, times(2)).migrateItem(isA(ItemGitInformation.class));
        verifyZeroInteractions(mockOperationalEventService);

        assertThat(result.getNumberOfItembankIds()).isEqualTo(2);
        assertThat(result.getNumberOfErrors()).isEqualTo(0);
    }

    @Test
    public void shouldContinueMigratingItemsWhenAnExceptionIsThrownFromMigrateItem() {
        final Pageable pageRequest = new PageRequest(0, mockItemIngestServiceProperties.getImrtPageQueryLimit());
        final Pageable nextPageRequest = new PageRequest(1, mockItemIngestServiceProperties.getImrtPageQueryLimit());
        final ItemGitInformation itemGitInformation = new ItemGitInformationBuilder().build();

        when(mockItemGitInformationPage.getContent())
                .thenReturn(Collections.singletonList(itemGitInformation));
        when(mockItemGitInformationPage.hasNext())
                .thenReturn(true, false);
        when(mockItemGitInformationPage.nextPageable())
                .thenReturn(nextPageRequest);
        when(mockItemGitInformationRepository.findAll(isA(PageRequest.class)))
                .thenReturn(mockItemGitInformationPage);
        doThrow(new GitLabApiRuntimeException("something bad happened"))
                .doNothing()
                .when(mockItemUpdateNotificationHandler).migrateItem(itemGitInformation);

        final ItemMigrationResponse result = itemMigrationService.migrate();

        verify(mockItemGitInformationPage, times(2)).getContent();
        verify(mockItemGitInformationPage, times(2)).nextPageable();
        verify(mockItemGitInformationPage, times(2)).hasNext();
        verify(mockItemGitInformationRepository).findAll(pageRequest);
        verify(mockItemGitInformationRepository).findAll(nextPageRequest);
        verify(mockItemUpdateNotificationHandler, times(2)).migrateItem(isA(ItemGitInformation.class));
        verify(mockOperationalEventService).serviceError(any(Logger.class), any(Exception.class), anyString(), anyVararg());

        assertThat(result.getNumberOfItembankIds()).isEqualTo(1);
        assertThat(result.getNumberOfErrors()).isEqualTo(1);
    }
}
