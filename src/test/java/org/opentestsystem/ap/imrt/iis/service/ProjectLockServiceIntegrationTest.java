package org.opentestsystem.ap.imrt.iis.service;

import org.junit.Test;
import org.opentestsystem.ap.imrt.iis.BaseIntegrationTest;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.jdbc.core.JdbcTemplate;

import java.util.Date;
import java.util.Optional;

import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertTrue;

public class ProjectLockServiceIntegrationTest extends BaseIntegrationTest {
    private static int projectId = 99;

    @Autowired
    JdbcTemplate jdbcTemplate;

    @Autowired
    ProjectLockServiceJdbcImpl projectLockService;

    @Test
    public void shouldLockNotExists() {
        // Lock a project
        Optional<Long> lock = projectLockService.lockProject(projectId);
        assertTrue(lock.isPresent());
    }

    @Test
    public void shouldNotLockIfExistsNotExpired() {
        // Lock a project
        Optional<Long> lock = projectLockService.lockProject(projectId);
        assertTrue(lock.isPresent());

        // Try to lock again, this should fail
        Optional<Long> nullLock = projectLockService.lockProject(projectId);
        assertFalse(nullLock.isPresent());
    }

    @Test
    public void shouldNotUnlockIfWrongLockId() {
        // Lock a project
        Optional<Long> lock = projectLockService.lockProject(projectId);
        assertTrue(lock.isPresent());

        // Unlock with the wrong lock ID
        projectLockService.unlockProject(projectId, lock.get() + 1);

        // Try to lock again, this should fail
        Optional<Long> nullLock = projectLockService.lockProject(projectId);
        assertFalse(nullLock.isPresent());
    }

    @Test
    public void shouldLockAfterUnlock() {
        // Lock a project
        Optional<Long> lock = projectLockService.lockProject(projectId);
        assertTrue(lock.isPresent());

        // Unlock with the correct lock ID
        projectLockService.unlockProject(projectId, lock.get());

        // Now we should be able to relock
        lock = projectLockService.lockProject(projectId);
        assertTrue(lock.isPresent());
    }

    @Test
    public void shouldLockIfExpired() {
        // Lock a project
        Optional<Long> lock = projectLockService.lockProject(projectId);
        assertTrue(lock.isPresent());

        // Now manually set the lock time back just over 60 seconds
        Date now = new Date();
        jdbcTemplate.update("update project_lock set locked_at = ? where project_id = ?", new Object[]{new Date(now.getTime() - 61 * 1000), projectId});

        // Now we should be able to relock
        lock = projectLockService.lockProject(projectId);
        assertTrue(lock.isPresent());
    }
}
