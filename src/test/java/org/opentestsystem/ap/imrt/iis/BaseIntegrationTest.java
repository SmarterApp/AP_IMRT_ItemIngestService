package org.opentestsystem.ap.imrt.iis;

import org.junit.Before;
import org.junit.runner.RunWith;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.StimItem;
import org.opentestsystem.ap.imrt.iis.model.ImrtItem;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.test.autoconfigure.web.servlet.AutoConfigureMockMvc;
import org.springframework.boot.test.context.SpringBootTest;
import org.springframework.jdbc.core.JdbcTemplate;
import org.springframework.test.context.junit4.SpringRunner;
import org.springframework.test.web.servlet.MockMvc;

import java.util.Date;

/**
 * Base class for all spring boot integration tests, including repository tests.
 * If all tests extend this base class, they will all use the same spring context,
 * which will make the tests run much faster. Just be sure not to dirty up the
 * context in ways that will affect other tests
 */
@RunWith(SpringRunner.class)
@SpringBootTest
@AutoConfigureMockMvc
public class BaseIntegrationTest {

    @Autowired
    protected JdbcTemplate jdbcTemplate;

    @Autowired
    protected MockMvc mvc;

    @Before
    public void setup() {
        // Before each test, empty out the tables in the test db.
        jdbcTemplate.execute("DELETE FROM item_git");
        jdbcTemplate.execute("DELETE FROM item");
        jdbcTemplate.execute("TRUNCATE TABLE project_lock");
    }

    /**
     * Generate a fully populated ImrtItem to use in testing
     * @return  A fully populated ImrtItem
     */
    protected ImrtItem generateItem() {
        Item item = new StimItem("testId");
        ImrtItem imrtItem = new ImrtItem();
        imrtItem.setId("123");
        imrtItem.setSubject("subject");
        imrtItem.setGrade("grade 1");
        imrtItem.setWorkflowStatus("created");
        imrtItem.setItemType("type");
        imrtItem.setDok("dok");
        imrtItem.setItemCreatedAt(new Date());
        imrtItem.setItemCreatedBy("me");
        imrtItem.setItemJson(item);
        imrtItem.setUpdatedBy("you");
        return imrtItem;
    }

}
