package org.opentestsystem.ap.imrt.iis.client;

import org.gitlab4j.api.GitLabApi;
import org.gitlab4j.api.GitLabApiException;
import org.gitlab4j.api.ProjectApi;
import org.gitlab4j.api.RepositoryFileApi;
import org.gitlab4j.api.models.Namespace;
import org.gitlab4j.api.models.RepositoryFile;
import org.gitlab4j.api.systemhooks.ProjectSystemHookEvent;
import org.gitlab4j.api.webhook.EventProject;
import org.gitlab4j.api.webhook.PushEvent;
import org.junit.Before;
import org.junit.Test;
import org.junit.runner.RunWith;
import org.mockito.Mock;
import org.mockito.runners.MockitoJUnitRunner;
import org.opentestsystem.ap.imrt.common.service.OperationalEventService;
import org.opentestsystem.ap.imrt.iis.config.ItemBankProperties;

import java.util.Optional;

import static org.junit.Assert.assertEquals;
import static org.junit.Assert.assertFalse;
import static org.junit.Assert.assertTrue;
import static org.mockito.Matchers.any;
import static org.mockito.Matchers.eq;
import static org.mockito.Mockito.mock;
import static org.mockito.Mockito.times;
import static org.mockito.Mockito.verify;
import static org.mockito.Mockito.verifyZeroInteractions;
import static org.mockito.Mockito.when;

@RunWith(MockitoJUnitRunner.class)
public class GitlabClientImplTest {
    @Mock
    private GitLabApi gitLabApi;

    @Mock
    private ItemBankProperties itemBankProperties;

    @Mock
    private ItemEventListener itemEventListener;

    @Mock
    private OperationalEventService operationalEventService;

    // Object under test
    private GitlabClientImpl client;

    @Before
    public void setup() {
        client = new GitlabClientImpl(itemBankProperties, operationalEventService);
        client.setGitLabApi(gitLabApi);
     }

    @Test
    public void shouldGetFile() throws GitLabApiException {
        RepositoryFile file = new RepositoryFile();
        RepositoryFileApi api = mock(RepositoryFileApi.class);
        when(api.getFile("test", 55, "master")).thenReturn(file);
        when(gitLabApi.getRepositoryFileApi()).thenReturn(api);

        Optional<RepositoryFile> result = client.getFile("test", 55, "master");
        assertTrue(result.isPresent());
        assertEquals(file, result.get());
        verify(api, times(1)).getFile("test", 55, "master");
    }

    @Test
    public void errorOnGetFile() throws GitLabApiException {
        Exception e = new GitLabApiException("Test");
        RepositoryFileApi api = mock(RepositoryFileApi.class);
        when(api.getFile("test", 55, "master")).thenThrow(e);
        when(gitLabApi.getRepositoryFileApi()).thenReturn(api);

        Optional<RepositoryFile> result = client.getFile("test", 55, "master");
        assertFalse(result.isPresent());
        verify(api, times(1)).getFile("test", 55, "master");
    }

    @Test
    public void shouldAddHookWhenMonitorItem() throws GitLabApiException {
        ProjectApi api = mock(ProjectApi.class);
        when(gitLabApi.getProjectApi()).thenReturn(api);
        int projectId = 55;
        String url = "testUrl";
        when(itemBankProperties.getWebhookUrl()).thenReturn(url);
        client.monitorItem(projectId);
        verify(api, times(1)).addHook(projectId, url, true, false, false);
    }

    @Test
    public void errorWhenMonitorItem() throws GitLabApiException {
        int projectId = 55;
        String url = "testUrl";
        ProjectApi api = mock(ProjectApi.class);
        Exception e = new GitLabApiException("Test");
        when(gitLabApi.getProjectApi()).thenReturn(api);
        when(api.addHook(projectId, url, true, false, false)).thenThrow(e);
        when(itemBankProperties.getWebhookUrl()).thenReturn(url);
        try {
            client.monitorItem(projectId);
        } catch (RuntimeException re) {
            assertEquals(re.getCause(), e);
            verify(api, times(1)).addHook(projectId, url, true, false, false);
            verify(operationalEventService, times(1)).serviceError(any(), eq(e), any(), eq(projectId));
        }
    }

    @Test
    public void noListenerOnProjectCreate() {
        ProjectSystemHookEvent event = new ProjectSystemHookEvent();
        // There is no listener configured. Nothing will happen
        client.onProjectEvent(event);
        verifyZeroInteractions(itemEventListener);
    }

    @Test
    public void wrongEventOnProjectCreate() {
        ProjectSystemHookEvent event = new ProjectSystemHookEvent();
        // Set the listener, but have the wrong type of event, nothing will happen
        client.setItemEventListener(itemEventListener);
        client.onProjectEvent(event);
        verifyZeroInteractions(itemEventListener);
    }

    @Test
    public void wrongGroupOnProjectCreate() {
        // Now the correct type of event, but the wrong group, nothing will happen
        client.setItemEventListener(itemEventListener);
        String group = "testGroup";
        when(itemBankProperties.getGroup()).thenReturn(group);
        Namespace gitGroup = new Namespace();
        gitGroup.setPath("NotTestGroup");
        client.setGroup(gitGroup);
        CreateProjectSystemHookEvent createEvent = new CreateProjectSystemHookEvent();
        createEvent.setPathWithNamespace(group+"rest of path");
        client.onProjectEvent(createEvent);
        verifyZeroInteractions(itemEventListener);
    }

    @Test
    public void shouldCreateItemOnProjectCreate() {
        client.setItemEventListener(itemEventListener);
        String group = "testGroup";
        when(itemBankProperties.getGroup()).thenReturn(group);
        Namespace gitGroup = new Namespace();
        gitGroup.setPath(group);
        client.setGroup(gitGroup);
        CreateProjectSystemHookEvent createEvent = new CreateProjectSystemHookEvent();
        createEvent.setPathWithNamespace(group+"rest of path");
        createEvent.setProjectId(77);
        client.onProjectEvent(createEvent);
        verify(itemEventListener, times(1)).onCreateItem(77);
    }

    @Test
    public void noListenerOnPushEvent() {
        int projectId = 99;
        PushEvent event = new PushEvent();
        EventProject project = new EventProject();
        project.setPathWithNamespace("testGroup/22");
        event.setProject(project);
        event.setProjectId(projectId);

        // There is no listener configured. Nothing will happen
        client.onPushEvent(event);
        verifyZeroInteractions(itemEventListener);

    }

    @Test
    public void wrongGroupOnPushEvent() {
        int projectId = 99;
        PushEvent event = new PushEvent();
        EventProject project = new EventProject();
        project.setPathWithNamespace("testGroup/22");
        event.setProject(project);
        event.setProjectId(projectId);

         // Set the listener, but use the wrong branch. Nothing will happen
        client.setItemEventListener(itemEventListener);
        event.setRef("refs/heads/develop");
        client.onPushEvent(event);
        verifyZeroInteractions(itemEventListener);
    }

    @Test
    public void shouldUpdateItemOnPushEvent() {
        int projectId = 99;
        PushEvent event = new PushEvent();
        EventProject project = new EventProject();
        project.setPathWithNamespace("testGroup/22");
        event.setProject(project);
        event.setProjectId(projectId);

        // Set the listener, use the correct branch.
        client.setItemEventListener(itemEventListener);
        event.setRef("refs/heads/master");
        client.onPushEvent(event);
        verify(itemEventListener, times(1)).onUpdateItem(projectId);
    }

    /**
     * gitlab4j has a class with this name, but it is private and therefore inaccessible. Create
     * this one so we can pass it into onProjectEvent and have it detect the correct class name
     */
    private static final class CreateProjectSystemHookEvent extends ProjectSystemHookEvent {

    }
}
