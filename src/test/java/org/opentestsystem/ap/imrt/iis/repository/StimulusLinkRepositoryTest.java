package org.opentestsystem.ap.imrt.iis.repository;

import org.junit.Before;
import org.junit.Test;
import org.opentestsystem.ap.imrt.common.model.ImrtItem;
import org.opentestsystem.ap.imrt.common.model.Stimulus;
import org.opentestsystem.ap.imrt.common.model.StimulusLink;
import org.opentestsystem.ap.imrt.common.repository.ImrtItemRepository;
import org.opentestsystem.ap.imrt.common.repository.StimulusRepository;
import org.opentestsystem.ap.imrt.iis.BaseIntegrationTest;
import org.opentestsystem.ap.imrt.iis.builder.StimulusBuilder;
import org.opentestsystem.ap.imrt.iis.builder.TestImrtItemBuilder;
import org.springframework.beans.factory.annotation.Autowired;

import static org.assertj.core.api.Assertions.assertThat;

public class StimulusLinkRepositoryTest extends BaseIntegrationTest {

    @Autowired
    private StimulusLinkRepository stimulusLinkRepository;

    @Autowired
    private ImrtItemRepository imrtItemRepository;

    @Autowired
    private StimulusRepository stimulusRepository;

    private ImrtItem imrtItem;
    private Stimulus stimulus;

    @Before
    public void createItems() {
        // create items in the DB, for our foreign key constraint
        imrtItem = new TestImrtItemBuilder().build();
        imrtItem = imrtItemRepository.save(imrtItem);

        stimulus = new StimulusBuilder().build();
        stimulus = stimulusRepository.save(stimulus);
    }

    @Test
    public void shouldCreateStimulusLink() {
        StimulusLink link = new StimulusLink(imrtItem, stimulus);
        link.setUpdatedBy("me");
        link = stimulusLinkRepository.save(link);
        assertThat(link).isEqualToComparingFieldByFieldRecursively(stimulusLinkRepository.findOne(imrtItem.getKey()));
    }

    @Test
    public void shouldDeleteStimulusLink() {
        StimulusLink link = new StimulusLink(imrtItem, stimulus);
        link.setUpdatedBy("me");
        link = stimulusLinkRepository.save(link);
        // There should be one row in the DB after the save
        assertThat(stimulusLinkRepository.findAll().size()).isEqualTo(1);
        stimulusLinkRepository.delete(link);
        // There should be no rows in the DB after the delete
        assertThat(stimulusLinkRepository.findAll().size()).isEqualTo(0);
    }
}
