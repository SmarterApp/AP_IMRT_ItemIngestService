package org.opentestsystem.ap.imrt.iis.core.mapper;

import org.junit.Test;
import org.opentestsystem.ap.common.imrt.model.BaseItem;
import org.opentestsystem.ap.common.imrt.model.KeywordContent;
import org.opentestsystem.ap.common.model.EqItem;
import org.opentestsystem.ap.common.model.EqPart;
import org.opentestsystem.ap.common.model.TiItem;

import java.util.Collection;
import java.util.Collections;

import static org.assertj.core.api.Assertions.assertThat;
import static org.assertj.core.api.Assertions.fail;
import static org.mockito.Mockito.mock;
import static org.opentestsystem.ap.common.imrt.model.KeywordContentSection.EqSection.LEFT_LABEL;
import static org.opentestsystem.ap.common.imrt.model.KeywordContentSection.EqSection.PROMPT;
import static org.opentestsystem.ap.common.imrt.model.KeywordContentSection.EqSection.RIGHT_LABEL;
import static org.opentestsystem.ap.common.imrt.model.KeywordContentSection.EqSection.SPANISH_LEFT_LABEL;
import static org.opentestsystem.ap.common.imrt.model.KeywordContentSection.EqSection.SPANISH_PROMPT;
import static org.opentestsystem.ap.common.imrt.model.KeywordContentSection.EqSection.SPANISH_RIGHT_LABEL;

public class EqKeywordContentMapperTest {
    private EqKeywordContentMapper mapper = new EqKeywordContentMapper();

    @Test
    public void shouldHandleEqItems() {
        assertThat(mapper.isSupportedItem(new EqItem("123"))).isTrue();
    }

    @Test
    public void shouldConvertItemContent() {
        String englishContent = "    <p>English</p> text";
        String spanishContent = "Spanish     text ";

        EqPart englishPart = new EqPart();
        englishPart.setLeftLabel(" English Part Left        ");
        englishPart.setRightLabel(" English Right");

        EqPart spanishPart = new EqPart();
        spanishPart.setLeftLabel("<p> Spanish</p> left");
        spanishPart.setRightLabel("Spanish Right");

        EqItem eqItem = new EqItem("123");
        eqItem.getCore().getEn().setPrompt(englishContent);
        eqItem.getCore().getEn().setParts(Collections.singletonList(englishPart));

        eqItem.getTranslations().getEsp().setPrompt(spanishContent);
        eqItem.getTranslations().getEsp().setParts(Collections.singletonList(spanishPart));

        BaseItem baseItem = mock(BaseItem.class);

        Collection<KeywordContent> keywordContents = mapper.findKeywordForItem(baseItem, eqItem);

        assertThat(keywordContents).hasSize(6);

        for (KeywordContent content : keywordContents) {
            assertThat(content.getItem()).isEqualTo(baseItem);
            switch (content.getSection()) {
                case PROMPT:
                    assertThat(content.getContent()).isEqualTo("English text");
                    break;
                case SPANISH_PROMPT:
                    assertThat(content.getContent()).isEqualTo("Spanish text");
                    break;
                case RIGHT_LABEL:
                    assertThat(content.getContent()).isEqualTo("English Right");
                    break;
                case LEFT_LABEL:
                    assertThat(content.getContent()).isEqualTo("English Part Left");
                    break;
                case SPANISH_RIGHT_LABEL:
                    assertThat(content.getContent()).isEqualTo("Spanish Right");
                    break;
                case SPANISH_LEFT_LABEL:
                    assertThat(content.getContent()).isEqualTo("Spanish left");
                    break;
                default:
                    fail("Found invalid section " + content.getSection());
            }
        }
    }

    @Test
    public void shouldSuppressBlankLabels() {
        String englishContent = "    <p>English</p> text";
        String spanishContent = "Spanish     text ";

        EqPart englishPart = new EqPart();
        englishPart.setLeftLabel("       ");
        englishPart.setRightLabel(" English Right");

        EqPart spanishPart = new EqPart();
        spanishPart.setLeftLabel("<p> Spanish</p> left");
        spanishPart.setRightLabel(null);

        EqItem eqItem = new EqItem("123");
        eqItem.getCore().getEn().setPrompt(englishContent);
        eqItem.getCore().getEn().setParts(Collections.singletonList(englishPart));

        eqItem.getTranslations().getEsp().setPrompt(spanishContent);
        eqItem.getTranslations().getEsp().setParts(Collections.singletonList(spanishPart));

        BaseItem baseItem = mock(BaseItem.class);

        Collection<KeywordContent> keywordContents = mapper.findKeywordForItem(baseItem, eqItem);

        assertThat(keywordContents).hasSize(4);

        for (KeywordContent content : keywordContents) {
            assertThat(content.getItem()).isEqualTo(baseItem);
            switch (content.getSection()) {
                case LEFT_LABEL:
                    fail("Expected no left label content");
                    break;
                case SPANISH_RIGHT_LABEL:
                    fail("Expected no left label content");
                    break;
            }
        }
    }

    @Test(expected = IllegalArgumentException.class)
    public void shouldHandleIfWrongTypeIsPassedIn() {
        mapper.findKeywordForItem(mock(BaseItem.class), new TiItem("123"));
    }
}