package org.opentestsystem.ap.imrt.iis.business;

import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.iis.model.ItemRevision;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

/**
 * Business rule to capture the time when the item workflow status was modified
 */
@Component
public class TimeInWorkflowRule implements ItemRevisionComparisonRule {
    private static final Logger logger = LoggerFactory.getLogger(TimeInWorkflowRule.class);

    @Override
    public ItemRevision applyBusinessRule(ItemGitInformation existing, ItemRevision current) {
        logger.debug("Existing workflow {} current workflow {}",
                existing != null ? existing.getItem().getWorkflowStatus() : null,
                current.getItem().getWorkflowStatus());
        if (null == existing || !current.getItem().getWorkflowStatus().equals(existing.getItem().getWorkflowStatus())) {
            logger.debug("Workflow status has changed. Setting workflowStatusSetAt to {}",
                    current.getItemGitInformation().getCurrentCommitDate());
            current.getItem().setWorkflowStatusSetAt(current.getItemGitInformation().getCurrentCommitDate());
        }
        return current;
    }
}
