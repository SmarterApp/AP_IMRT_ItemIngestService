package org.opentestsystem.ap.imrt.iis.message;

import org.opentestsystem.ap.imrt.common.exception.NotFoundException;
import org.opentestsystem.ap.imrt.common.service.OperationalEventService;
import org.opentestsystem.ap.imrt.iis.service.ItemValidationService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

@Component
public class ItemValidationListener implements ItemMessageListener {
    private static final Logger LOG = LoggerFactory.getLogger(ItemValidationListener.class);

    private final OperationalEventService operationalEventService;
    private final ItemValidationService itemValidationService;

    public ItemValidationListener(final OperationalEventService operationalEventService, final ItemValidationService itemValidationService) {
        this.operationalEventService = operationalEventService;
        this.itemValidationService = itemValidationService;
    }

    @Override
    public void handleMessage(final Integer itemBankId) {
        operationalEventService.debug(LOG,"Validating item bank id " + itemBankId);

        try {
            itemValidationService.validateItem(itemBankId);
            operationalEventService.info(LOG, "Validated item bank id {}", itemBankId);
        } catch (NotFoundException nfe) {
            operationalEventService.error(LOG, nfe, "Could not find item to validate for item {}", itemBankId);
        } catch (Exception e) {
            operationalEventService.error(LOG, e, "Unhandled error trying to validate item bank id {}", itemBankId);
            throw e;
        }
    }
}
