package org.opentestsystem.ap.imrt.iis.core.impl;

import org.opentestsystem.ap.common.imrt.model.BaseItem;
import org.opentestsystem.ap.common.imrt.model.ItemAssignment;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.imrt.iis.core.ItemToBaseItemMapper;
import org.springframework.stereotype.Component;

import java.time.LocalDateTime;
import java.time.ZoneOffset;
import java.time.format.DateTimeFormatter;
import java.util.List;
import java.util.Set;
import java.util.stream.Collectors;

@Component
public class AssigneeMapper implements ItemToBaseItemMapper {
    @Override
    public void updateBaseItemProperties(final BaseItem baseItem, final Item iatItem, final String author) {
        baseItem.getAssignments().clear();

        Set<org.opentestsystem.ap.common.model.ItemAssignment> iatAssignments = iatItem.getAssignments();
        List<ItemAssignment> assignments = iatAssignments.stream()
                .map(itemAssignment -> mapAssignment(author, baseItem, itemAssignment))
                .sorted((o1, o2) -> o1.getAssignedTo().compareToIgnoreCase(o2.getAssignedTo()))
                .collect(Collectors.toList());

        StringBuilder assignedTo = new StringBuilder();
        StringBuilder assignedBy = new StringBuilder();
        StringBuilder assignedDate = new StringBuilder();

        DateTimeFormatter formatter = DateTimeFormatter.ofPattern("MM/dd/yy").withZone(ZoneOffset.UTC);

        for (int i = 0; i < assignments.size(); i++) {
            ItemAssignment assignment = assignments.get(i);
            assignedTo.append(assignment.getAssignedTo());
            assignedBy.append(assignment.getAssignedBy());
            assignedDate.append(LocalDateTime.ofInstant(assignment.getAssignedDate(), ZoneOffset.UTC).format(formatter));

            if (i != assignments.size() - 1) {
                assignedTo.append(", ");
                assignedBy.append(", ");
                assignedDate.append(", ");
            }
        }

        baseItem.setAssignedBy(assignedBy.toString());
        baseItem.setAssignedTo(assignedTo.toString());
        baseItem.setAssignedDates(assignedDate.toString());

        baseItem.getAssignments().addAll(assignments);
    }

    private ItemAssignment mapAssignment(final String author,  final BaseItem baseItem, final org.opentestsystem.ap.common.model.ItemAssignment itemAssignment) {
        ItemAssignment assignment = new ItemAssignment();
        assignment.setItem(baseItem);
        assignment.setUpdatedBy(author);
        assignment.setAssignedBy(itemAssignment.getAssignedBy());
        assignment.setAssignedTo(itemAssignment.getAssignedTo());
        assignment.setAssignedDate(itemAssignment.getAssignedDate().toInstant());
        return assignment;
    }
}
