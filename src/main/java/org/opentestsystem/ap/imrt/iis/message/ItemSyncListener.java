package org.opentestsystem.ap.imrt.iis.message;

import org.opentestsystem.ap.common.imrt.service.OperationalEventService;
import org.opentestsystem.ap.common.rest.item.ItemCommitResponse;
import org.opentestsystem.ap.imrt.iis.client.ItemEventListener;
import org.opentestsystem.ap.imrt.iis.model.ItemUpdateEvent;
import org.opentestsystem.ap.imrt.iis.service.BaseItemService;
import org.opentestsystem.ap.imrt.iis.service.ItemDeleteNotificationHandler;
import org.opentestsystem.ap.imrt.iis.service.ItemService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;

import java.time.Duration;
import java.time.Instant;
import java.util.Optional;
import java.util.UUID;

@Component
public class ItemSyncListener {
    private static final Logger LOG = LoggerFactory.getLogger(ItemSyncListener.class);
    private final BaseItemService baseItemService;
    private final OperationalEventService logger;
    private final ItemEventListener itemEventListener;
    private final ItemService itemService;
    private final ItemDeleteNotificationHandler itemDeleteNotificationHandler;

    public ItemSyncListener(final BaseItemService baseItemService, final OperationalEventService logger, final ItemEventListener itemEventListener, final ItemService itemService, final ItemDeleteNotificationHandler itemDeleteNotificationHandler) {
        this.baseItemService = baseItemService;
        this.logger = logger;
        this.itemEventListener = itemEventListener;
        this.itemService = itemService;
        this.itemDeleteNotificationHandler = itemDeleteNotificationHandler;
    }

    public void synchronizeItem(Integer itemId) {
        Instant start = Instant.now();
        Optional<UUID> maybeCommitId = baseItemService.findItemCommitId(itemId);
        logger.info(LOG, "Commit retrieved for the item {} in {} ms", itemId, Duration.between(start, Instant.now()).toMillis());
        ItemUpdateEvent event;

        if (maybeCommitId.isPresent()) {
            logger.info(LOG, "Item id {} being synced with last commit id {}", itemId, maybeCommitId.get());
            event = new ItemUpdateEvent(itemId, maybeCommitId.get());
        } else {
            Instant imsCallStart = Instant.now();
            logger.info(LOG, "Item id {} had no commits so syncing fresh from first commit", itemId);
            ItemCommitResponse itemCommitResponse = itemService.findAllCommits(itemId).orElseThrow(() -> new RuntimeException("Could not find item commits from IMS for item " + itemId));
            logger.info(LOG, "Get commits from IMS for item {} took {} ms", itemId, Duration.between(imsCallStart, Instant.now()).toMillis());

            if (itemCommitResponse.getCommits().isEmpty()) {
                logger.info(LOG, "No commits found for Item id {} had no commits so syncing fresh from first commit", itemId);
                itemDeleteNotificationHandler.processItemMessage(itemId);
                return;
            }

            event = new ItemUpdateEvent(itemId, itemCommitResponse.getCommits().get(0));
        }

        logger.info(LOG, "Sending update event for item id {} using commit id {}: {} ms ", event.getItemId(), event.getCommitId(), Duration.between(start, Instant.now()).toMillis());
        itemEventListener.onUpdateItem(event);
    }
}
