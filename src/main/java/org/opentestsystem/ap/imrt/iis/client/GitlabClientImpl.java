package org.opentestsystem.ap.imrt.iis.client;

import org.gitlab4j.api.GitLabApi;
import org.gitlab4j.api.GitLabApiException;
import org.gitlab4j.api.models.Namespace;
import org.gitlab4j.api.systemhooks.*;
import org.gitlab4j.api.webhook.*;
import org.opentestsystem.ap.imrt.iis.config.ItemBankProperties;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.boot.autoconfigure.condition.ConditionalOnProperty;
import org.springframework.stereotype.Component;

import javax.annotation.PostConstruct;
import javax.servlet.http.HttpServletRequest;

/**
 * Wrapper around the gitlab4j java web client:
 * https://github.com/gmessner/gitlab4j-api
 */
@Component
@ConditionalOnProperty(value = "test.enabled", havingValue = "false", matchIfMissing = true)
public class GitlabClientImpl implements SystemHookListener, WebHookListener, GitlabClient {
    private static final Logger logger = LoggerFactory.getLogger(GitlabClientImpl.class);

    private final ItemBankProperties gitlabProperties;
    private GitLabApi gitLabApi;
    private Namespace group;
    private final SystemHookManager systemHookManager = new SystemHookManager();
    private final WebHookManager webHookManager = new WebHookManager();
    private ProjectEventListener projectListener;

    @Autowired
    public GitlabClientImpl(ItemBankProperties gitlabProperties) {
        this.gitlabProperties = gitlabProperties;
    }

    @PostConstruct
    public void init() {
        gitLabApi = new GitLabApi(gitlabProperties.getHost(), gitlabProperties.getAccessToken());
        try {
            group = gitLabApi.getNamespaceApi().findNamespaces(gitlabProperties.getGroup()).get(0);
            systemHookManager.addListener(this);
            webHookManager.addListener(this);
            logger.info("GitlabClient Initialized");
        } catch (GitLabApiException e) {
            // TODO figure out exception handling strategy
            logger.error("Unable to find group {}", gitlabProperties.getGroup(), e);
            throw new RuntimeException(e);
        }
    }

    @Override
    public void setProjectEventListener(ProjectEventListener listener) {
        projectListener = listener;
    }

    @Override
    public void handleSystemHook(HttpServletRequest request) {
        try {
            // This method parses the data and then invokes the SystemHookListener overrides
            // in this class based on the contents.
            systemHookManager.handleEvent(request);
        } catch (GitLabApiException e) {
            // TODO figure out exception handling strategy
            logger.error("Unable to handle system hook call {}", request, e);
        }
    }

    @Override
    public void handleWebHook(HttpServletRequest request) {
        try {
            // This method parses the data and then invokes the WebHookListener overrides
            // in this class based on the contents.
            webHookManager.handleEvent(request);
        } catch (GitLabApiException e) {
            // TODO figure out exception handling strategy
            logger.error("Unable to handle web hook call {}", request, e);
        }
    }

    @Override
    public void addProjectMergeHook(Integer projectId) {
        logger.debug("Adding project merge hook id {} url {}", projectId, gitlabProperties.getWebhookUrl());
        try {
            gitLabApi.getProjectApi().addHook(projectId, gitlabProperties.getWebhookUrl(), false, false, true);
        } catch (GitLabApiException e) {
            // TODO figure out exception handling strategy
            logger.error("Unable to register webhook for projectId {}", projectId, e);
        }
    }

    @Override
    public void onProjectEvent(ProjectSystemHookEvent event) {
        logger.debug("onProjectEvent path {}", event.getPathWithNamespace());
        // Check to see if this is a project create event for our group
        if (projectListener != null && event.getClass().getSimpleName().equals("CreateProjectSystemHookEvent") &&
                event.getPathWithNamespace().startsWith(group.getPath())) {
            // If so, notify our listener
            projectListener.onCreateProject(event.getProjectId());
        }
    }

    @Override
    public void onTeamMemberEvent(TeamMemberSystemHookEvent event) {

    }

    @Override
    public void onUserEvent(UserSystemHookEvent event) {

    }

    @Override
    public void onKeyEvent(KeySystemHookEvent event) {

    }

    @Override
    public void onGroupEvent(GroupSystemHookEvent event) {

    }

    @Override
    public void onGroupMemberEvent(GroupMemberSystemHookEvent event) {

    }

    @Override
    public void onPushEvent(PushSystemHookEvent event) {

    }

    @Override
    public void onTagPushEvent(TagPushSystemHookEvent event) {

    }

    @Override
    public void onRepositoryEvent(RepositorySystemHookEvent event) {

    }

    @Override
    public void onBuildEvent(BuildEvent buildEvent) {

    }

    @Override
    public void onIssueEvent(IssueEvent event) {

    }

    @Override
    public void onMergeRequestEvent(MergeRequestEvent event) {
        logger.debug("onMergeRequestEvent class name {} event name {} state",
                event.getClass().getSimpleName(), event.getObjectKind(), event.getObjectAttributes().getState());
        // Check to see that this is a completed merge request into the master branch
        if (projectListener != null && event.getObjectAttributes().getState().equals("merged") &&
                event.getObjectAttributes().getTargetBranch().equals("master")) {
            // If so, notify the listener
            projectListener.onMergeToMaster(event.getObjectAttributes().getTargetProjectId());
        }

    }

    @Override
    public void onNoteEvent(NoteEvent noteEvent) {

    }

    @Override
    public void onPipelineEvent(PipelineEvent pipelineEvent) {

    }

    @Override
    public void onPushEvent(PushEvent pushEvent) {

    }

    @Override
    public void onTagPushEvent(TagPushEvent tagPushEvent) {

    }

    @Override
    public void onWikiPageEvent(WikiPageEvent wikiEvent) {

    }

    public GitLabApi getGitLabApi() {
        return gitLabApi;
    }

    public void setGitLabApi(GitLabApi gitLabApi) {
        this.gitLabApi = gitLabApi;
    }
}
