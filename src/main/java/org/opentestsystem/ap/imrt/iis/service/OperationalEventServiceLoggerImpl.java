package org.opentestsystem.ap.imrt.iis.service;

import org.slf4j.Logger;
import org.springframework.stereotype.Service;

import java.util.ArrayList;
import java.util.Arrays;
import java.util.List;

/**
 * Implementation of OperationalEventService that logs the events
 */
@Service
public class OperationalEventServiceLoggerImpl extends OperationalEventService {
    @Override
    public void itemEvent(Logger logger, ItemEventType type, Integer key, Integer id, Integer projectId) {
        StringBuilder builder = new StringBuilder();
        List<Object> args = new ArrayList<>(3);
        builder.append("ITEM EVENT type: {}");
        args.add(type);
        append(args, builder, " key: {}", key);
        append(args, builder, " id: {}", id);
        append(args, builder, " projectId: {}", projectId);
        logger.info(builder.toString(), args.toArray());
    }

    /**
     * Appends a message to a string builder and corresponding value to an argument list,
     * only if the value is non-null
     * @param args  Existing list of arguments to append to
     * @param builder  Existing string builder to append to
     * @param message  Message to append, if value is non-null
     * @param value  Value to append, if it is non-null
     */
    private void append(List<Object> args, StringBuilder builder, String message, Object value){
        if(value != null) {
            builder.append(message);
            args.add(value);
        }
    }

    @Override
    public void serviceEvent(Logger logger, ServiceEventType type, Exception e, String format, Object... args) {
        String output = type + ": " + format;
        List<Object> allArgs = new ArrayList<>(Arrays.asList(args));
        allArgs.add(e);
        if (ServiceEventType.SERVICE_ERROR == type) {
            logger.error(output, allArgs.toArray());
        } else {
            logger.warn(output, allArgs.toArray());
        }
    }
}
