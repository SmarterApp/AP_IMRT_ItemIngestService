package org.opentestsystem.ap.imrt.iis.service.impl;

import org.opentestsystem.ap.common.imrt.model.BaseItem;
import org.opentestsystem.ap.common.imrt.repository.AttachmentRepository;
import org.opentestsystem.ap.common.imrt.repository.BaseItemRepository;
import org.opentestsystem.ap.common.imrt.repository.ContentUpdateNeedRepository;
import org.opentestsystem.ap.common.imrt.repository.FormRepository;
import org.opentestsystem.ap.common.imrt.repository.KeywordContentRepository;
import org.opentestsystem.ap.common.imrt.repository.ValidationResultsRepository;
import org.opentestsystem.ap.imrt.iis.service.BaseItemService;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.Optional;

@Service
public class BaseItemServiceImpl implements BaseItemService {
    private final BaseItemRepository baseItemRepository;
    private final ValidationResultsRepository validationResultsRepository;
    private final KeywordContentRepository keywordContentRepository;
    private final ContentUpdateNeedRepository contentUpdateNeedRepository;
    private final AttachmentRepository attachmentRepository;
    private final FormRepository formRepository;

    public BaseItemServiceImpl(final BaseItemRepository baseItemRepository,
                               final ValidationResultsRepository validationResultsRepository,
                               final KeywordContentRepository keywordContentRepository,
                               final ContentUpdateNeedRepository contentUpdateNeedRepository,
                               final AttachmentRepository attachmentRepository,
                               final FormRepository formRepository) {
        this.baseItemRepository = baseItemRepository;
        this.validationResultsRepository = validationResultsRepository;
        this.keywordContentRepository = keywordContentRepository;
        this.contentUpdateNeedRepository = contentUpdateNeedRepository;
        this.attachmentRepository = attachmentRepository;
        this.formRepository = formRepository;
    }

    @Override
    public Optional<BaseItem> findBaseItemByItemId(final int itemId) {
        return Optional.ofNullable(baseItemRepository.findById(itemId));
    }

    @Override
    public Optional<BaseItem> findBaseItemByItemId(final String itemId) {
        return findBaseItemByItemId(Integer.parseInt(itemId));
    }

    @Transactional
    @Override
    public void deleteItem(final BaseItem item) {
        validationResultsRepository.deleteAllByItem(item);
        keywordContentRepository.deleteAllByItem(item);
        contentUpdateNeedRepository.deleteAllByItem(item);
        attachmentRepository.deleteByAttachmentKeyItem(item);
        formRepository.deleteAllByItem(item);
        baseItemRepository.delete(item);
    }
}
