package org.opentestsystem.ap.imrt.iis.service;

import org.gitlab4j.api.models.Commit;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.iis.client.ItemBankClient;
import org.opentestsystem.ap.imrt.iis.model.ItemBankItemRevision;
import org.opentestsystem.ap.imrt.iis.repository.ItemGitInformationRepository;

public class ItemMigrationServiceImpl implements ItemMigrationService {
    private final ItemGitInformationRepository itemGitInformationRepository;
    private final ProjectLockService projectLockService;
    private final ItemBankClient itemBankClient;

    public ItemMigrationServiceImpl(final ItemGitInformationRepository itemGitInformationRepository,
                                    final ProjectLockService projectLockService,
                                    final ItemBankClient itemBankClient) {
        this.itemGitInformationRepository = itemGitInformationRepository;
        this.projectLockService = projectLockService;
        this.itemBankClient = itemBankClient;
    }

    @Override
    public void migrate() {
        // get a page of ItemGitInformations

        // for each ItemGitInformation in the page, call migrateItem
    }

    private void migrateItem(final ItemGitInformation itemGitInformation) {
        long lock = projectLockService.lockProject(itemGitInformation.getProjectId());

        try {
            final ItemBankItemRevision itemBankItemRevision = itemBankClient.getItemBankItemRevision(itemGitInformation);

        } finally {
            projectLockService.unlockProject(itemGitInformation.getProjectId(), lock);
        }
    }
}
