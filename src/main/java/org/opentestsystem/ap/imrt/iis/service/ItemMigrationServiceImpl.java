package org.opentestsystem.ap.imrt.iis.service;

import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.iis.config.ItemIngestServiceProperties;
import org.opentestsystem.ap.imrt.iis.repository.ItemGitInformationRepository;
import org.springframework.data.domain.Page;
import org.springframework.data.domain.PageRequest;
import org.springframework.data.domain.Pageable;

public class ItemMigrationServiceImpl implements ItemMigrationService {
    private final ItemGitInformationRepository itemGitInformationRepository;
    private final ItemUpdateNotificationHandler itemUpdateNotificationHandler;
    private final ItemIngestServiceProperties itemIngestServiceProperties;

    public ItemMigrationServiceImpl(final ItemGitInformationRepository itemGitInformationRepository,
                                    final ItemUpdateNotificationHandler itemUpdateNotificationHandler,
                                    final ItemIngestServiceProperties itemIngestServiceProperties) {
        this.itemGitInformationRepository = itemGitInformationRepository;
        this.itemUpdateNotificationHandler = itemUpdateNotificationHandler;
        this.itemIngestServiceProperties = itemIngestServiceProperties;
    }

    @Override
    public void migrate() {
        Pageable pageRequest = new PageRequest(0, itemIngestServiceProperties.getPageSize());
        Page<ItemGitInformation> itemGitInformationPage;

        do {
            itemGitInformationPage = itemGitInformationRepository.findAll(pageRequest);

            itemGitInformationPage.getContent()
                    .forEach(itemUpdateNotificationHandler::migrateItem);

            pageRequest = itemGitInformationPage.nextPageable();
        } while (itemGitInformationPage.hasNext());
    }
}
