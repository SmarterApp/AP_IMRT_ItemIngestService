package org.opentestsystem.ap.imrt.iis.repository.impl;

import org.opentestsystem.ap.imrt.iis.repository.ItemRepository;
import org.springframework.jdbc.core.namedparam.MapSqlParameterSource;
import org.springframework.jdbc.core.namedparam.NamedParameterJdbcTemplate;
import org.springframework.stereotype.Repository;

@Repository
public class ItemRepositoryImpl implements ItemRepository {
    private final NamedParameterJdbcTemplate namedParameterJdbcTemplate;

    private static final String validationUpdateSQL = "    UPDATE item\n" +
            "    SET\n" +
            "      severe_validation_result_count = :severeResultCount,\n" +
            "      degraded_validation_result_count = :degradedResultCount,\n" +
            "      tolerable_validation_result_count = :tolerableValidationCount,\n" +
            "      benign_validation_result_count = :benignValidationResultCount\n" +
            "    where\n" +
            "      key = :itemKey";

    public ItemRepositoryImpl(NamedParameterJdbcTemplate namedParameterJdbcTemplate) {
        this.namedParameterJdbcTemplate = namedParameterJdbcTemplate;
    }

    @Override
    public void updateValidationCounts(Integer key, int severeErrorCount, int degradedErrorCount, int tolerableErrorCount, int benignErrorCount) {
        MapSqlParameterSource parameterSource = new MapSqlParameterSource("itemKey", key)
                .addValue("severeResultCount", severeErrorCount)
                .addValue("degradedResultCount", degradedErrorCount)
                .addValue("tolerableValidationCount", tolerableErrorCount)
                .addValue("benignValidationResultCount", benignErrorCount);

        namedParameterJdbcTemplate.update(validationUpdateSQL, parameterSource);
    }
}
