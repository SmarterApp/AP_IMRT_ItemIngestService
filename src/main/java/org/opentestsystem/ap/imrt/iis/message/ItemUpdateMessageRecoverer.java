package org.opentestsystem.ap.imrt.iis.message;

import org.opentestsystem.ap.imrt.common.service.OperationalEventService;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.amqp.core.Message;
import org.springframework.amqp.rabbit.retry.RejectAndDontRequeueRecoverer;

/**
 * Handles when an update message has been rejected more than the configured threshold
 * <p>
 * Threshold is set within {@link org.opentestsystem.ap.imrt.iis.config.ItemIngestServiceProperties}
 */
public class ItemUpdateMessageRecoverer extends RejectAndDontRequeueRecoverer {
    private static final Logger logger = LoggerFactory.getLogger(ItemUpdateMessageRecoverer.class);
    private final OperationalEventService operationalEventService;

    public ItemUpdateMessageRecoverer(final OperationalEventService operationalEventService) {
        this.operationalEventService = operationalEventService;
    }

    @Override
    public void recover(final Message message, final Throwable cause) {
        operationalEventService.serviceError(logger, cause, "Unable to process update message: %s", message);
    }
}
