package org.opentestsystem.ap.imrt.iis.repository;


import org.gitlab4j.api.GitLabApi;
import org.gitlab4j.api.GitLabApiException;
import org.gitlab4j.api.Pager;
import org.gitlab4j.api.models.Branch;
import org.gitlab4j.api.models.Commit;
import org.gitlab4j.api.models.Group;
import org.gitlab4j.api.models.Namespace;
import org.gitlab4j.api.models.Project;
import org.gitlab4j.api.models.ProjectHook;
import org.gitlab4j.api.models.RepositoryFile;
import org.opentestsystem.ap.common.imrt.service.OperationalEventService;
import org.opentestsystem.ap.imrt.iis.config.ItemBankProperties;
import org.opentestsystem.ap.imrt.iis.exception.GitLabApiRuntimeException;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.http.HttpStatus;
import org.springframework.stereotype.Repository;

import java.util.Date;
import java.util.List;
import java.util.Optional;

@Repository
public class GitLabRepositoryImpl implements GitLabRepository {
    private static final Logger LOG = LoggerFactory.getLogger(GitLabRepositoryImpl.class);
    private final GitLabApi gitLabApi;
    private final ItemBankProperties itemBankProperties;
    private final OperationalEventService logger;

    @Autowired
    public GitLabRepositoryImpl(final GitLabApi gitLabApi,
                                final ItemBankProperties itemBankProperties,
                                final OperationalEventService logger) {
        this.gitLabApi = gitLabApi;
        this.itemBankProperties = itemBankProperties;
        this.logger = logger;
    }

    @Override
    public Optional<ProjectHook> addProjectHook(final int itemBankId) {
        try {
            return Optional.of(gitLabApi.getProjectApi().addHook(itemBankId,
                    itemBankProperties.getWebhookUrl(),
                    true,
                    false,
                    false));
        } catch (final GitLabApiException e) {
            throw new GitLabApiRuntimeException(e,
                    String.format("Error attempting to create project hook on itemBankId %d", itemBankId));
        }
    }

    @Override
    public List<Namespace> findAllNamespaces(final String projectGroupName) {
        try {
            return gitLabApi.getNamespaceApi().findNamespaces(projectGroupName);
        } catch (final GitLabApiException e) {
            throw new GitLabApiRuntimeException(e,
                    String.format("Error attempting to get all namespaces for %s from %s",
                            projectGroupName,
                            itemBankProperties.getHost()));
        }
    }

    @Override
    public Optional<RepositoryFile> findFile(final int itemBankId, final String fileName, final String branchName) {
        try {
            return Optional.of(gitLabApi.getRepositoryFileApi().getFile(fileName, itemBankId, branchName));
        } catch (final GitLabApiException e) {
            if (e.getHttpStatus() == HttpStatus.NOT_FOUND.value()) {
                logger.debug(LOG,"Unable to find item.json on {} branch for itemBankId {} message {} reason {} http status {}",
                        branchName, itemBankId, e.getMessage(), e.getReason(), e.getHttpStatus());
                return Optional.empty();
            } else {
                throw new GitLabApiRuntimeException(e,
                        String.format("Error attempting to find file %s for itemBankId %d in branch %s",
                                fileName,
                                itemBankId,
                                branchName));
            }
        }
    }

    @Override
    public List<Branch> getAllBranches(final int itemBankId) {
        try {
            return gitLabApi.getRepositoryApi().getBranches(itemBankId);
        } catch (final GitLabApiException e) {
            throw new GitLabApiRuntimeException(e,
                    String.format("Error attempting to find all branches for itemBankId %d", itemBankId));
        }
    }

    @Override
    public List<ProjectHook> getAllProjectHooks(final int itemBankId) {
        try {
            return gitLabApi.getProjectApi().getHooks(itemBankId);
        } catch (final GitLabApiException e) {
            throw new GitLabApiRuntimeException(e,
                    String.format("Error attempting to find all project hooks for itemBankId %d", itemBankId));
        }
    }

    @Override
    public Optional<Pager<Commit>> findAllCommitsForFile(final int itemBankId,
                                                         final String fileName,
                                                         final String branchName,
                                                         final Date from,
                                                         final Date to,
                                                         final int pageSize) {
        try {
            return Optional.of(gitLabApi.getCommitsApi().getCommits(itemBankId,
                    branchName,
                    from,
                    to,
                    fileName,
                    pageSize));
        } catch (final GitLabApiException e) {
            throw new GitLabApiRuntimeException(e,
                    String.format("Error attempting to get a page of commits for itemBankId %d, fileName %s, branchName %s, from %s, to %s, pageSize %d",
                            itemBankId,
                            fileName,
                            branchName,
                            from,
                            to,
                            pageSize));
        }
    }

    @Override
    public Optional<Pager<Project>> findAllProjects(final int pageSize) {
        try {
            return Optional.of(gitLabApi.getProjectApi().getProjects(pageSize));
        } catch (final GitLabApiException e) {
            throw new GitLabApiRuntimeException(e, "Error attempting to get a page of projects");
        }
    }

    @Override
    public Optional<Pager<Project>> findAllProjects(final int groupId, final int pageSize) {
        try {
            return Optional.of(gitLabApi.getGroupApi().getProjects(groupId, pageSize));
        } catch (final GitLabApiException e) {
            throw new GitLabApiRuntimeException(e, "Error attempting to get a page of projects");
        }
    }

    @Override
    public Optional<Group> findGroup(final String groupPath) {
        try {
            return Optional.of(gitLabApi.getGroupApi().getGroup(groupPath));
        } catch (final GitLabApiException e) {
            if (e.getHttpStatus() == HttpStatus.NOT_FOUND.value()) {
                LOG.debug("Unable to find group for group path {}, Exception: {}",
                        groupPath, e);

                return Optional.empty();
            }
            throw new GitLabApiRuntimeException(e,
                    String.format("Error finding group for group path %s", groupPath));
        }
    }

    @Override
    public Optional<Project> findProject(int projectId) {
        try {
            return Optional.of(gitLabApi.getProjectApi().getProject(projectId));
        } catch (final GitLabApiException e) {
            if (e.getHttpStatus() == HttpStatus.NOT_FOUND.value()) {
                logger.debug(LOG,"Unable to project for id {} message {} reason {} http status {}",
                        projectId, e.getMessage(), e.getReason(), e.getHttpStatus());
                return Optional.empty();
            }

            throw new GitLabApiRuntimeException(e, "");
        }
    }

    @Override
    public Optional<Commit> findCommit(final int itemBankId, final String commitHash) {
        try {
            return Optional.of(gitLabApi.getCommitsApi().getCommit(itemBankId, commitHash));
        } catch (final GitLabApiException e) {
            if (e.getHttpStatus() == HttpStatus.NOT_FOUND.value()) {
                LOG.debug("Unable to find commit for itemBankId {} commit hash {}.  Message {} reason {} http status {}",
                        itemBankId,
                        commitHash,
                        e.getMessage(),
                        e.getReason(),
                        e.getHttpStatus());

                return Optional.empty();
            }
            throw new GitLabApiRuntimeException(e,
                    String.format("Error attempting to get a commit for itemBankId %d, commit hash %s",
                            itemBankId,
                            commitHash));
        }
    }
}
