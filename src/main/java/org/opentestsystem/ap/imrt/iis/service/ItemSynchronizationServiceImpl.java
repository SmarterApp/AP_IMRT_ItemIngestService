package org.opentestsystem.ap.imrt.iis.service;

import org.apache.commons.collections4.IterableUtils;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.common.service.OperationalEventService;
import org.opentestsystem.ap.imrt.iis.client.ItemBankClient;
import org.opentestsystem.ap.imrt.iis.client.ItemEventListener;
import org.opentestsystem.ap.imrt.iis.model.ItemSynchronizationResponse;
import org.opentestsystem.ap.imrt.iis.repository.ItemGitInformationRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.Duration;
import java.time.Instant;
import java.util.List;
import java.util.stream.Collectors;

@Service
public class ItemSynchronizationServiceImpl implements ItemSynchronizationService {
    private static final Logger LOG = LoggerFactory.getLogger(ItemSynchronizationServiceImpl.class);
    private final ItemBankClient itemBankClient;
    private final ItemEventListener itemEventListener;
    private final ItemGitInformationRepository itemGitInformationRepository;
    private final OperationalEventService logger;

    @Autowired
    public ItemSynchronizationServiceImpl(final ItemBankClient itemBankClient,
                                          final ItemEventListener itemEventListener,
                                          final ItemGitInformationRepository itemGitInformationRepository,
                                          final OperationalEventService logger) {
        this.itemBankClient = itemBankClient;
        this.itemEventListener = itemEventListener;
        this.itemGitInformationRepository = itemGitInformationRepository;
        this.logger = logger;
    }

    @Override
    public ItemSynchronizationResponse synchronize() {
        final Instant getProjectIdsStartTime = Instant.now();
        logger.info(LOG, "Getting item bank ids from source control");

        final List<Integer> allItemBankIdsInSourceControl = itemBankClient.getAllItemBankIds();

        logger.info(LOG, "retrieved {} item bank ids from source control in {} seconds",
                allItemBankIdsInSourceControl.size(),
                Duration.between(getProjectIdsStartTime, Instant.now()).getSeconds());

        int numberOfItemsWithoutWebhook = 0;
        for (final Integer projectId : allItemBankIdsInSourceControl) {
            // If the project does not any webhooks in place or if the project does not have any webhooks that match
            // IMRT's webhook URL configuration, create one.
            if (!itemBankClient.isProjectMonitored(projectId)) {
                numberOfItemsWithoutWebhook++;
                itemEventListener.onCreateItem(projectId);
            }

            itemEventListener.onUpdateItem(projectId);
        }

        // Find out if we have any item bank ids in IMRT that do not exist in source control.  If we do, they need to be
        // deleted from the IMRT database.
        final List<ItemGitInformation> itemGitInformationList =
                IterableUtils.toList(itemGitInformationRepository.findAll());

        final List<Integer> itemBankIdsInImrt = itemGitInformationList.stream()
                .map(ItemGitInformation::getProjectId)
                .collect(Collectors.toList());

        itemBankIdsInImrt.removeAll(allItemBankIdsInSourceControl);

        // Delete all items that are in IMRT but not in source control - IMRT should never have more items than source
        // control has
        if (!itemBankIdsInImrt.isEmpty()) {
            for (final Integer itemBankId : itemBankIdsInImrt) {
                itemEventListener.onDeleteItem(itemBankId);
            }
        }

        return new ItemSynchronizationResponse(numberOfItemsWithoutWebhook,
                allItemBankIdsInSourceControl.size(),
                itemBankIdsInImrt.size());
    }
}
