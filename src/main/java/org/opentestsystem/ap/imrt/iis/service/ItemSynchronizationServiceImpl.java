package org.opentestsystem.ap.imrt.iis.service;

import org.opentestsystem.ap.imrt.iis.client.ItemBankClient;
import org.opentestsystem.ap.imrt.iis.client.ItemEventListener;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class ItemSynchronizationServiceImpl implements ItemSynchronizationService {
    private static final Logger logger = LoggerFactory.getLogger(ItemSynchronizationService.class);
    private final ItemBankClient itemBankClient;
    private final ItemEventListener itemEventListener;

    @Autowired
    public ItemSynchronizationServiceImpl(final ItemBankClient itemBankClient,
                                          final ItemEventListener itemEventListener) {
        this.itemBankClient = itemBankClient;
        this.itemEventListener = itemEventListener;
    }

    @Override
    public void synchronizeItem(int itemBankId) {
        logger.debug("Syncing itemBankId {}", itemBankId);
        // If the project does not any webhooks in place or if the project does not have any webhooks that match
        // IMRT's webhook URL configuration, create one.
        if (!itemBankClient.isProjectMonitored(itemBankId)) {
            itemEventListener.onCreateItem(itemBankId);
        }
        itemEventListener.onUpdateItem(itemBankId);
    }

    @Override
    public List<Integer> getAllItemBankIds() {
        logger.debug("Getting list of itemBankIds from itembank");
        List<Integer> ids = itemBankClient.getAllItemBankIds();
        logger.debug("Found {} itemBankIds to process", ids.size());
        return ids;
    }
}
