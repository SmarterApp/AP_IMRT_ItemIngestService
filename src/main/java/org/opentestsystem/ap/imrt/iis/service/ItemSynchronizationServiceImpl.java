package org.opentestsystem.ap.imrt.iis.service;

import org.opentestsystem.ap.imrt.iis.client.ItemBankClient;
import org.opentestsystem.ap.imrt.iis.client.ItemEventListener;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.util.List;

@Service
public class ItemSynchronizationServiceImpl implements ItemSynchronizationService {
    private final ItemBankClient itemBankClient;
    private final ItemEventListener itemEventListener;

    @Autowired
    public ItemSynchronizationServiceImpl(final ItemBankClient itemBankClient,
                                          final ItemEventListener itemEventListener) {
        this.itemBankClient = itemBankClient;
        this.itemEventListener = itemEventListener;
    }

    @Override
    public void synchronize() {
        final List<Integer> projectIds = itemBankClient.getProjectIds(100);

        for (final Integer projectId : projectIds) {
            // If the project does not any webhooks in place or if the project does not have any webhooks that match
            // IMRT's webhook URL configuration, create one.
            if (!itemBankClient.isProjectMonitored(projectId)) {
                itemEventListener.onCreateItem(projectId);
            }

            itemEventListener.onUpdateItem(projectId);
        }
    }
}
