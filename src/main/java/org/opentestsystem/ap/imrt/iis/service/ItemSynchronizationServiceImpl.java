package org.opentestsystem.ap.imrt.iis.service;

import org.gitlab4j.api.Pager;
import org.gitlab4j.api.models.Project;
import org.gitlab4j.api.models.ProjectHook;
import org.opentestsystem.ap.imrt.common.model.ImrtItem;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.common.repository.ImrtItemRepository;
import org.opentestsystem.ap.imrt.common.service.OperationalEventService;
import org.opentestsystem.ap.imrt.iis.client.ItemBankClient;
import org.opentestsystem.ap.imrt.iis.client.ItemEventListener;
import org.opentestsystem.ap.imrt.iis.config.ItemBankProperties;
import org.opentestsystem.ap.imrt.iis.model.ItemBankItemRevision;
import org.opentestsystem.ap.imrt.iis.repository.ItemGitInformationRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.beans.factory.annotation.Autowired;
import org.springframework.stereotype.Service;

import java.time.Instant;
import java.util.List;
import java.util.Optional;

@Service
public class ItemSynchronizationServiceImpl implements ItemSynchronizationService {
    private static final Logger logger = LoggerFactory.getLogger(ItemSynchronizationServiceImpl.class);

    private final ItemBankClient itemBankClient;
    private final OperationalEventService operationalEventService;
    private final ImrtItemRepository imrtItemRepository;
    private final ItemGitInformationRepository itemGitInformationRepository;
    private final ItemEventListener itemEventListener;

    @Autowired
    public ItemSynchronizationServiceImpl(final ItemBankClient itemBankClient,
                                          final OperationalEventService operationalEventService,
                                          final ImrtItemRepository imrtItemRepository,
                                          final ItemGitInformationRepository itemGitInformationRepository,
                                          final ItemEventListener itemEventListener) {
        this.itemBankClient = itemBankClient;
        this.operationalEventService = operationalEventService;
        this.imrtItemRepository = imrtItemRepository;
        this.itemGitInformationRepository = itemGitInformationRepository;
        this.itemEventListener = itemEventListener;
    }

    @Override
    public void synchronize(final Instant start) {
        Pager<Project> projectsPager = itemBankClient.getProjects(100);

        while (projectsPager.hasNext()) {
            for (final Project project : projectsPager.next()) {
                // If the project does not any webhooks in place or if the project does not have any webhooks that match
                // IMRT's webhook URL configuration, create one.
                final List<ProjectHook> projectHooks = itemBankClient.getProjectHooks(project.getId());
                if (projectHooks.isEmpty()
                    || projectHooks.stream().noneMatch(h -> h.getUrl().equals(itemBankClient.getItemBankProperties().getWebhookUrl()))) {
                    itemEventListener.onCreateItem(project.getId());
                }

                // Does the item exist in the IMRT database? If not, create a new item and move onto the next one.
                final ImrtItem existingItem = imrtItemRepository.findOne(project.getId());
                if (existingItem == null) {
                    // Only need to call onUpdateItem here; if the project was missing its project webhook, it has
                    // already been created in the previous step.  The ItemUpdateNotificationHandler will pick up the
                    // update message and write the necessary data to the database.
                    itemEventListener.onUpdateItem(project.getId());

                    continue;
                }

                // Otherwise, start looking at commit history.  If the current commit hash IMRT knows about does not
                // match the most recent commit hash in source control, start the update process for this item.
                final ItemGitInformation itemGitInformation = itemGitInformationRepository.findOne(project.getId());
                final Optional<ItemBankItemRevision> mostRecentRevision = itemBankClient.getMostRecentRevision(project.getId());
                if (!mostRecentRevision.isPresent()) {
                    // log warning and continue processing.  We should always have at least one commit to master for
                    // each item.
                    operationalEventService.serviceWarning(logger,
                        null,
                        "Could not find any revisions on master branch for item id '{}'",
                        project.getName());

                    continue;
                }

                if (!mostRecentRevision.get().getRevisionId().equals(itemGitInformation.getCurrentCommitHash())) {
                    itemEventListener.onUpdateItem(project.getId());
                }
            }
        }
    }
}
