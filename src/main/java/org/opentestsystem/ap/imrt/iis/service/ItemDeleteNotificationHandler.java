package org.opentestsystem.ap.imrt.iis.service;

import org.opentestsystem.ap.imrt.common.model.BaseItem;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.common.model.Stimulus;
import org.opentestsystem.ap.imrt.common.repository.ImrtItemRepository;
import org.opentestsystem.ap.imrt.common.repository.StimulusLinkRepository;
import org.opentestsystem.ap.imrt.common.repository.StimulusRepository;
import org.opentestsystem.ap.imrt.common.service.OperationalEventService;
import org.opentestsystem.ap.imrt.iis.repository.ItemGitInformationRepository;
import org.opentestsystem.ap.imrt.iis.repository.ItemLogRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Component;
import org.springframework.transaction.annotation.Transactional;

import java.util.Optional;

@Component
public class ItemDeleteNotificationHandler {
    private static final Logger logger = LoggerFactory.getLogger(ItemDeleteNotificationHandler.class);
    private final OperationalEventService operationalEventService;
    private final ProjectLockService projectLockService;
    private final ImrtItemRepository imrtItemRepository;
    private final ItemGitInformationRepository itemGitInformationRepository;
    private final ItemLogRepository itemLogRepository;
    private final StimulusLinkRepository stimulusLinkRepository;
    private final StimulusRepository stimulusRepository;

    public ItemDeleteNotificationHandler(final OperationalEventService operationalEventService,
                                         final ProjectLockService projectLockService,
                                         final ImrtItemRepository imrtItemRepository,
                                         final ItemGitInformationRepository itemGitInformationRepository,
                                         final ItemLogRepository itemLogRepository,
                                         final StimulusLinkRepository stimulusLinkRepository,
                                         final StimulusRepository stimulusRepository) {
        this.operationalEventService = operationalEventService;
        this.projectLockService = projectLockService;
        this.imrtItemRepository = imrtItemRepository;
        this.itemGitInformationRepository = itemGitInformationRepository;
        this.itemLogRepository = itemLogRepository;
        this.stimulusLinkRepository = stimulusLinkRepository;
        this.stimulusRepository = stimulusRepository;
    }

    @Transactional
    public void processItemMessage(final Integer itemBankId) {
        logger.info("Received item delete message for itembank id {}", itemBankId);

        // get a lock on the project - a project should not be deleted if someone is actively working on it
        final long projectLockId = projectLockService.lockProject(itemBankId);
        logger.debug("Acquired lock for item id {}", itemBankId);
        try {
            final Optional<ItemGitInformation> maybeItemGitInformation =
                    itemGitInformationRepository.findOneByProjectId(itemBankId);
            if (!maybeItemGitInformation.isPresent()) {
                logger.debug(String.format("could not find git information for item bank id %d", itemBankId));
                return;
            }

            final ItemGitInformation itemGitInformation = maybeItemGitInformation.get();

            itemGitInformationRepository.delete(itemGitInformation);
            itemLogRepository.deleteAllByItemLogKeyItem(itemGitInformation.getItem());

            final BaseItem itemToDelete = itemGitInformation.getItem();

            if (itemToDelete instanceof Stimulus) {
                // Since the stimulus is being deleted, we need to break the association of this stimulus to all items
                // it was associated to.
                stimulusLinkRepository.deleteAllByStimulusKey(itemToDelete.getKey());
                stimulusRepository.delete(itemToDelete.getKey());
            } else {
                // Since a single item is being deleted, we only need to remove this particular item's association to a
                // stimulus.  If the item is not associated to a stimulus, then the stimulusLinkRepository delete will
                // affect zero rows.
                stimulusLinkRepository.deleteByItemKey(itemToDelete.getKey());
                imrtItemRepository.delete(itemToDelete.getKey());
            }

            operationalEventService.itemDeletedEvent(logger,
                    itemToDelete.getKey(),
                    itemToDelete.getId(),
                    itemGitInformation.getProjectId());
        } finally {
            // release the lock
            projectLockService.unlockProject(itemBankId, projectLockId);
        }
    }
}
