package org.opentestsystem.ap.imrt.iis.model;

import com.google.common.primitives.Ints;
import org.apache.commons.lang.StringUtils;
import org.opentestsystem.ap.common.model.AbstractAssessmentItemCore;
import org.opentestsystem.ap.common.model.Administration;
import org.opentestsystem.ap.common.model.AssessmentItemCore;
import org.opentestsystem.ap.common.model.FieldTestData;
import org.opentestsystem.ap.common.model.Form;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.ItemMetadata;
import org.opentestsystem.ap.common.model.TestAdministration;
import org.opentestsystem.ap.imrt.common.model.Attachment;
import org.opentestsystem.ap.imrt.common.model.AttachmentFileTypes;
import org.opentestsystem.ap.imrt.common.model.BaseItem;
import org.opentestsystem.ap.imrt.common.model.ImrtItem;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.common.model.ItemLog;
import org.opentestsystem.ap.imrt.common.model.ItemLogKey;
import org.opentestsystem.ap.imrt.common.model.Stimulus;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

import static org.apache.commons.lang.StringUtils.isNotBlank;
import static org.springframework.util.StringUtils.isEmpty;

/**
 * Implementation of ItemRevision interface that converts from AP common domain
 * model, with some associated git information, into IMRT domain model objects
 */
public final class ItemRevisionImpl implements ItemRevision {
    private final Item item;
    private final ItemBankItemRevision itemBankItemRevision;
    private final ItemGitInformation existingItemGitInformation;
    private ItemMetadata metadata;
    private BaseItem baseItem;
    private ItemGitInformation itemGitInformation;
    private Integer linkedStimulusId;
    private ItemLog itemLog;

    public ItemRevisionImpl(ItemBankItemRevision itemBankItemRevision, ItemGitInformation existingItemGitInformation) {
        this.item = itemBankItemRevision.getItem();
        this.existingItemGitInformation = existingItemGitInformation;
        this.itemBankItemRevision = itemBankItemRevision;

        createDomainModelObjects();
    }

    /**
     * Covert item bank data into domain model objects
     */
    private void createDomainModelObjects() {
        findMetadata();
        createImrtItem();
        createItemGitInformation();
        updateItemStandardIds(baseItem);
        createItemLog();
    }

    /**
     * Finds the ItemMetadata by inspecting the type of the item. Stores it
     * in the metadata field. Also stores linkedStimulusId if found.
     */
    private void findMetadata() {
        if (item.getCore() instanceof AbstractAssessmentItemCore) {
            AbstractAssessmentItemCore core = (AbstractAssessmentItemCore) item.getCore();
            metadata = core.getMetadata();
            String stimulusId = core.getStimulusId();
            if (!isEmpty(stimulusId)) {
                linkedStimulusId = convertItemId(stimulusId);
            }
        } else if (item.getCore() != null) {
            metadata = item.getCore().getMetadata();
        }
    }

    /**
     * Creates an ImrtItem from the item bank data and stores it in the
     * baseItem field.
     */
    private void createImrtItem() {
        baseItem = ItemConstants.ItemType.TYPE_STIM.equals(item.getType()) ? new Stimulus() : new ImrtItem();

        baseItem.setId(convertItemId(item.getId()));
        baseItem.setItemJson(item);
        baseItem.setItemType(item.getType());
        baseItem.setUpdatedBy(itemBankItemRevision.getAuthor());
        baseItem.setAssociatedStimulusId(linkedStimulusId);
        baseItem.setBeingCreated(itemBankItemRevision.isBeingCreated());

        if (item.getWorkflow() != null) {
            baseItem.setWorkflowStatus(StringUtils.defaultString(item.getWorkflow().getWorkflowStatusCode()));
        }

        // Metadata may be null if this is a tutorial item
        if (metadata != null) {
            baseItem.setSubject(StringUtils.defaultString(metadata.getSubject()));
            baseItem.setGrade(StringUtils.defaultString(metadata.getIntendedGrade()));
            baseItem.setDepthOfKnowledge(StringUtils.defaultString(metadata.getDepthOfKnowledge()));
            baseItem.setOrganizationTypeId(StringUtils.defaultString(metadata.getOrganizationTypeId()));
            baseItem.setOrganizationName(StringUtils.defaultString(metadata.getOrganizationName()));
            baseItem.setContentTaskModel(StringUtils.defaultString(metadata.getContentTaskModel()));
            baseItem.setPerformanceTask(StringUtils.defaultString(metadata.getPerformanceTask()));
            baseItem.setWritingPurpose(StringUtils.defaultString(metadata.getWritingPurpose()));
            baseItem.setItemAuthor(metadata.getItemAuthor());
        }
        if (null == existingItemGitInformation) {
            // We have never seen this item before, so set the creation info from this commit
            baseItem.setItemCreatedBy(itemBankItemRevision.getAuthor());
            baseItem.setItemCreatedAt(itemBankItemRevision.getRevisionDate());
            baseItem.setWorkflowStatusSetAt(itemBankItemRevision.getRevisionDate());
        } else {
            BaseItem existingImrtItem = existingItemGitInformation.getItem();
            baseItem.setItemCreatedBy(existingImrtItem.getItemCreatedBy());
            baseItem.setItemCreatedAt(existingImrtItem.getItemCreatedAt());
            baseItem.setWorkflowStatusSetAt(existingImrtItem.getWorkflowStatusSetAt());
            baseItem.setKey(existingImrtItem.getKey());
        }

        if (item.getTextToSpeech() != null) {
            baseItem.setVisualTTSRequired(item.getTextToSpeech().getVisualTTSRequired());
            baseItem.setVisualTTSProvided(item.getTextToSpeech().isVisualTTSProvided());
            baseItem.setSightTTSProvided(item.getTextToSpeech().isSightTTSProvided());
        }

        populateItemWithAdministrationData(item, baseItem);

        populateItemWithContentRequiredData(item, baseItem);
    }

    /**
     * Set the content required fields for the {@link org.opentestsystem.ap.imrt.common.model.BaseItem}.
     */
    private void populateItemWithContentRequiredData(final Item item, final BaseItem baseItem) {
        if (item.getAsl() != null) {
            baseItem.setAslRequired(StringUtils.defaultString(item.getAsl().getAslRequired()));
            baseItem.setAslProvided(String.valueOf(item.getAsl().isAslProvided()));
            baseItem.setAslAttachments(getContentAttachments(baseItem,
                    item.getAsl().getAttachments(),
                    AttachmentFileTypes.ASL));
        }

        if (item.getBraille() != null) {
            baseItem.setBrailleRequired(item.getBraille().getBrailleRequired());
            baseItem.setBrailleProvided(String.valueOf(item.getBraille().isBrailleProvided()));
            baseItem.setBrailleAttachments(getContentAttachments(baseItem,
                    item.getBraille().getAttachments(),
                    AttachmentFileTypes.BRAILLE));
        }

        if (item.getCc() != null) {
            baseItem.setCcRequired(item.getCc().getCcRequired());
            baseItem.setCcProvided(String.valueOf(item.getCc().isCcProvided()));
            baseItem.setCcAttachments(getContentAttachments(baseItem,
                    item.getCc().getAttachments(),
                    AttachmentFileTypes.CC));
        }

        if (item.getTranslations() != null) {
            baseItem.setTranslationRequired(item.getTranslations().getEsp().isRequired());
            baseItem.setTranslationProvided(String.valueOf(item.getTranslations().getEsp().isProvided()));
        }
    }

    /**
     * Creates ItemGitInformation from the item bank data and stores it in
     * the itemGitInformation field
     */
    private void createItemGitInformation() {
        itemGitInformation = new ItemGitInformation();
        itemGitInformation.setItem(baseItem);
        itemGitInformation.setProjectId(itemBankItemRevision.getItemBankId());
        itemGitInformation.setProjectPath(itemBankItemRevision.getItemBankPath());
        itemGitInformation.setCurrentCommitDate(itemBankItemRevision.getRevisionDate());
        itemGitInformation.setCurrentCommitHash(itemBankItemRevision.getRevisionId());
        itemGitInformation.setUpdatedBy(itemBankItemRevision.getAuthor());
        itemGitInformation.setIngestSource(itemBankItemRevision.getIngestSource());
    }

    private void updateItemStandardIds(BaseItem item) {
        if (null == metadata) {
            return;
        }

        item.setPrimaryClaim(StringUtils.defaultString(metadata.getPrimaryClaim()));
        item.setPrimaryTarget(StringUtils.defaultString(metadata.getPrimaryTarget()));
        item.setPrimaryCommonCoreStandard(StringUtils.defaultString(metadata.getPrimaryCommonCoreStandard()));
        item.setPrimaryContentDomain(StringUtils.defaultString(metadata.getPrimaryContentDomain()));
        item.setSecondaryClaim(StringUtils.defaultString(metadata.getSecondaryClaim()));
        item.setSecondaryCommonCoreStandard(StringUtils.defaultString(metadata.getSecondaryCommonCoreStandard()));
        item.setSecondaryContentDomain(StringUtils.defaultString(metadata.getSecondaryContentDomain()));
        item.setSecondaryTarget(StringUtils.defaultString(metadata.getSecondaryTarget()));
        item.setTertiaryClaim(StringUtils.defaultString(metadata.getTertiaryClaim()));
        item.setTertiaryCommonCoreStandard(StringUtils.defaultString(metadata.getTertiaryCommonCoreStandard()));
        item.setTertiaryContentDomain(StringUtils.defaultString(metadata.getTertiaryContentDomain()));
        item.setTertiaryTarget(StringUtils.defaultString(metadata.getTertiaryTarget()));
        item.setQuaternaryClaim(StringUtils.defaultString(metadata.getQuaternaryClaim()));
        item.setQuaternaryCommonCoreStandard(StringUtils.defaultString(metadata.getQuaternaryCommonCoreStandard()));
        item.setQuaternaryContentDomain(StringUtils.defaultString(metadata.getQuaternaryContentDomain()));
        item.setQuaternaryTarget(StringUtils.defaultString(metadata.getQuaternaryTarget()));
    }

    private void populateItemWithAdministrationData(Item item, BaseItem baseItem) {
        if (!(item.getCore() instanceof AssessmentItemCore)) {
            baseItem.setExposuresCount(null);
            baseItem.setFormCount(null);
            baseItem.setItemDifficultyQuintile(null);
            return;
        }

        TestAdministration testAdministration = ((AssessmentItemCore) item.getCore()).getTestAdministration();

        //If the item has not been included in an administration them we cannot capture the data.
        if (testAdministration == null
                || testAdministration.getAdministrations() == null
                || testAdministration.getAdministrations().isEmpty()) {
            baseItem.setExposuresCount(null);
            baseItem.setFormCount(null);
            baseItem.setItemDifficultyQuintile(null);
            return;
        }

        final String fieldTestDataId = testAdministration.getFieldTestAdministrationId();
        int formCount = 0;
        int exposuresCount = 0;
        Optional<FieldTestData> fieldTestData = Optional.empty();

        for (Administration administration : testAdministration.getAdministrations()) {
            if (StringUtils.equals(administration.getAdministrationId(), fieldTestDataId)) {
                fieldTestData = Optional.of(administration.getFieldTestData());
            }

            for (Form form : administration.getForms()) {
                formCount++;
                if (form.getExposures() != null) {
                    exposuresCount += form.getExposures();
                }
            }
        }

        baseItem.setExposuresCount(exposuresCount);
        baseItem.setFormCount(formCount);

        if (fieldTestData.isPresent() && isNotBlank(fieldTestData.get().getItemDifficultyQuintile())) {
            baseItem.setItemDifficultyQuintile(Ints.tryParse(fieldTestData.get().getItemDifficultyQuintile()));
        }
    }

    /**
     * Create an itemLog entry for this revision
     */
    private void createItemLog() {
        ItemLogKey itemLogKey = new ItemLogKey(baseItem, itemBankItemRevision.getRevisionId());
        itemLog = new ItemLog();
        itemLog.setItemLogKey(itemLogKey);
        itemLog.setCommitDate(itemBankItemRevision.getRevisionDate());
        itemLog.setUpdatedBy(itemBankItemRevision.getAuthor());
        itemLog.setIngestSource(itemBankItemRevision.getIngestSource());
    }

    /**
     * Converts IAT's string ids to numeric ids
     *
     * @param id the id String to be converted
     * @return the integer id
     * @throws IllegalArgumentException if the id is not a number
     */
    private static Integer convertItemId(String id) throws IllegalArgumentException {
        try {
            return Integer.valueOf(id);
        } catch (NumberFormatException nfe) {
            throw new IllegalArgumentException("The id is not a number and cannot be ingested into the system");
        }
    }

    /**
     * Map a collection of {@link org.opentestsystem.ap.common.model.Attachment}s to a collection of
     * {@link org.opentestsystem.ap.imrt.common.model.Attachment}s from the collection
     *
     * @param item           The {@link org.opentestsystem.ap.imrt.common.model.BaseItem} being stored in the database
     * @param iatAttachments The collection of {@link org.opentestsystem.ap.common.model.Attachment}s to map
     * @param fileType       The type of file being mapped
     * @return A {@link java.util.List<org.opentestsystem.ap.imrt.common.model.Attachment>} representing the content
     * attachments from IAT.
     */
    private List<Attachment> getContentAttachments(final BaseItem item,
                                                   final List<org.opentestsystem.ap.common.model.Attachment> iatAttachments,
                                                   final String fileType) {
        return iatAttachments.stream()
                .map(attachment -> new Attachment(item,
                        fileType,
                        attachment.getFileName(),
                        attachment.getUploadedDate().toInstant(),
                        item.getUpdatedBy()))
                .collect(Collectors.toList());
    }

    @Override
    public ItemGitInformation getItemGitInformation() {
        return itemGitInformation;
    }

    @Override
    public BaseItem getItem() {
        return baseItem;
    }

    @Override
    public Optional<Integer> getLinkedStimulusId() {
        return Optional.ofNullable(linkedStimulusId);
    }

    @Override
    public ItemLog getItemLog() {
        return itemLog;
    }
}
