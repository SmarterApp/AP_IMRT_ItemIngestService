package org.opentestsystem.ap.imrt.iis.model;

import com.google.common.collect.Lists;
import org.opentestsystem.ap.common.model.AbstractAssessmentItemCore;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemMetadata;
import org.opentestsystem.ap.common.model.StimItemCore;
import org.opentestsystem.ap.imrt.common.model.ImrtItem;
import org.opentestsystem.ap.imrt.common.model.ImrtItemBuilder;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformationBuilder;
import org.opentestsystem.ap.imrt.common.model.StandardId;
import org.opentestsystem.ap.imrt.common.model.StandardIdBuilder;

import java.time.Instant;
import java.util.List;
import java.util.Optional;

import static org.springframework.util.StringUtils.isEmpty;

/**
 * Implementation of ItemRevision interface that converts from AP common domain
 * model, with some associated git information, into IMRT domain model objects
 */
public final class ItemRevisionImpl implements ItemRevision {
    private final Item item;
    private final int gitId;
    private final String gitPath;
    private final String revisionId;
    private final Instant revisionDate;
    private final String author;
    private final ItemGitInformation existingItemGitInformation;
    private ItemMetadata metadata;
    private ImrtItem imrtItem;
    private ItemGitInformation itemGitInformation;
    private String linkedStimulusId;
    private final List<StandardId> standardIdList = Lists.newArrayList();

    public ItemRevisionImpl(Item item, int gitId, String gitPath, String revisionId, Instant revisionDate, String author,
                            ItemGitInformation existingItemGitInformation) {
        this.gitId = gitId;
        this.gitPath = gitPath;
        this.item = item;
        this.revisionId = revisionId;
        this.revisionDate = revisionDate;
        this.author = author;
        this.existingItemGitInformation = existingItemGitInformation;

        createDomainModelObjects();
    }

    /**
     * Covert item bank data into domain model objects
     */
    private void createDomainModelObjects() {
        findMetadata();
        createImrtItem();
        createItemGitInformation();
        createStandardIds();
    }

    /**
     * Finds the ItemMetadata by inspecting the type of the item. Stores it
     * in the metadata field. Also stores linkedStimulusId if found.
     */
    private void findMetadata() {
        if (item.getCore() instanceof AbstractAssessmentItemCore) {
            AbstractAssessmentItemCore core = (AbstractAssessmentItemCore) item.getCore();
            metadata = core.getMetadata();
            String stimulusId = core.getStimulusId();
            if (!isEmpty(stimulusId)) {
                linkedStimulusId = stimulusId;
            }
        } else if (item.getCore() instanceof StimItemCore) {
            metadata = ((StimItemCore) item.getCore()).getMetadata();
        }
    }

    /**
     * Creates an ImrtItem from the item bank data and stores it in the
     * imrtItem field.
     */
    private void createImrtItem() {
        ImrtItemBuilder builder = new ImrtItemBuilder()
                .withItem(item)
                .withId(item.getId())
                .withWorkflowStatus(item.getWorkflow().getWorkflowStatusCode())
                .withItemType(item.getType())
                .withUpdatedBy(author);

        // Metadata may be null if this is a tutorial item
        if (metadata != null) {
            builder.withSubject(metadata.getSubject());
            builder.withGrade(metadata.getGrade());
            builder.withDepthOfKnowledge(metadata.getDepthOfKnowledge());
        }
        if (null == existingItemGitInformation) {
            // We have never seen this item before, so set the creation info
            // From this commit
            builder.withItemCreatedBy(author);
            builder.withItemCreatedAt(revisionDate);
        } else {
            ImrtItem existingImrtItem = existingItemGitInformation.getItem();
            builder.withItemCreatedAt(existingImrtItem.getItemCreatedAt());
            builder.withItemCreatedBy(existingImrtItem.getItemCreatedBy());
            builder.withKey(existingImrtItem.getKey());
        }

        imrtItem = builder.build();
    }

    /**
     * Creates ItemGitInformation from the item bank data and stores it in
     * the itemGitInformation field
     */
    private void createItemGitInformation() {
        itemGitInformation = new ItemGitInformationBuilder()
                .withImrtItem(imrtItem)
                .withProjectId(gitId)
                .withProjectPath(gitPath)
                .withCurrentCommitHash(revisionId)
                .withUpdatedBy(author)
                //TODO - This is temporary and will be removed when all commits are processed
                .withCurrentCommitDate(Instant.now().minusMillis(1000000))
                .build();
    }

    /**
     * Creates the standardId objects if the associated data is present.
     * Standard Ids are stored in the standardId list field.
     */
    private void createStandardIds() {
        if (null == metadata) {
            return;
        }
        // TODO - how do we want to handle this constant?
        if ("ELA".equalsIgnoreCase(metadata.getSubject())) {
            createElaStandardId();
        } else {
            createNormalStandardIds();
        }
    }

    /**
     * Create a standard id domain object based on the current method IAT uses for ELA.
     * The id is only created if at least one value is populated. The id is stored
     * in the standardId list field.
     */
    private void createElaStandardId() {
        if (anyFieldsPopulated(metadata.getPrimaryClaim(),
                metadata.getContentDomain(), metadata.getPrimaryAssessmentTarget(),
                // TODO when supported metadata.getPrimaryEmphasis
                metadata.getPrimaryCommonCoreStandard())) {
            standardIdList.add(new StandardIdBuilder()
                    .withImrtItem(imrtItem)
                    .withType(1)
                    .withClaim(metadata.getPrimaryClaim())
                    .withContentDomain(metadata.getContentDomain())
                    .withTarget(metadata.getPrimaryAssessmentTarget())
                    .withEmphasis("")  // TODO when supported by IAT
                    .withCommonCoreStandard(metadata.getPrimaryCommonCoreStandard())
                    .withUpdatedBy(author)
                    .build());
        }
    }

    /**
     * Create standard id domain objects based on the primary, secondary, tertiary, and quaternay values
     * in the item metadata. Ids are only created if at least one value is populated. Standard ids are stored
     * in the standardIdList field.
     */
    private void createNormalStandardIds() {
        if (anyFieldsPopulated(metadata.getPrimaryClaim(),
                metadata.getPrimaryContentDomain(), metadata.getPrimaryAssessmentTarget(),
                // TODO when supported metadata.getPrimaryEmphasis
                metadata.getPrimaryCommonCoreStandard())) {
            standardIdList.add(new StandardIdBuilder()
                    .withImrtItem(imrtItem)
                    .withType(1)
                    .withClaim(metadata.getPrimaryClaim())
                    .withContentDomain(metadata.getPrimaryContentDomain())
                    .withTarget(metadata.getPrimaryAssessmentTarget())
                    .withEmphasis("")  // TODO when supported by IAT
                    .withCommonCoreStandard(metadata.getPrimaryCommonCoreStandard())
                    .withUpdatedBy(author)
                    .build());
        }
        if (anyFieldsPopulated(metadata.getSecondaryClaim(),
                metadata.getSecondaryContentDomain(), metadata.getSecondaryAssessmentTarget(),
                // TODO when supported metadata.getSecondaryEmphasis
                metadata.getSecondaryCommonCoreStandard())) {
            standardIdList.add(new StandardIdBuilder()
                    .withImrtItem(imrtItem)
                    .withType(2)
                    .withClaim(metadata.getSecondaryClaim())
                    .withContentDomain(metadata.getSecondaryContentDomain())
                    .withTarget(metadata.getSecondaryAssessmentTarget())
                    .withEmphasis("")  // TODO when supported by IAT
                    .withCommonCoreStandard(metadata.getSecondaryCommonCoreStandard())
                    .withUpdatedBy(author)
                    .build());
        }
        if (anyFieldsPopulated(metadata.getTertiaryClaim(),
                metadata.getTertiaryContentDomain(), metadata.getTertiaryAssessmentTarget(),
                // TODO when supported metadata.getTertiaryEmphasis
                metadata.getTertiaryCommonCoreStandard())) {
            standardIdList.add(new StandardIdBuilder()
                    .withImrtItem(imrtItem)
                    .withType(3)
                    .withClaim(metadata.getTertiaryClaim())
                    .withContentDomain(metadata.getTertiaryContentDomain())
                    .withTarget(metadata.getTertiaryAssessmentTarget())
                    .withEmphasis("")  // TODO when supported by IAT
                    .withCommonCoreStandard(metadata.getTertiaryCommonCoreStandard())
                    .withUpdatedBy(author)
                    .build());
        }
        if (anyFieldsPopulated(metadata.getQuaternaryClaim(),
                metadata.getQuaternaryContentDomain(), metadata.getQuaternaryAssessmentTarget(),
                // TODO when supported metadata.getQuaternaryEmphasis
                metadata.getQuaternaryCommonCoreStandard())) {
            standardIdList.add(new StandardIdBuilder()
                    .withImrtItem(imrtItem)
                    .withType(4)
                    .withClaim(metadata.getQuaternaryClaim())
                    .withContentDomain(metadata.getQuaternaryContentDomain())
                    .withTarget(metadata.getQuaternaryAssessmentTarget())
                    .withEmphasis("")  // TODO when supported by IAT
                    .withCommonCoreStandard(metadata.getQuaternaryCommonCoreStandard())
                    .withUpdatedBy(author)
                    .build());
        }
    }

    /**
     * Null safe checking on a set of fields to see if any of them are populated
     *
     * @param fields the set of fields to check
     * @return true if all fields are empty, false otherwise
     */
    private boolean anyFieldsPopulated(String... fields) {
        for (String field : fields) {
            if (!isEmpty(field)) {
                return true;
            }
        }
        return false;
    }

    @Override
    public ItemGitInformation getItemGitInformation() {
        return itemGitInformation;
    }

    @Override
    public ImrtItem getImrtItem() {
        return imrtItem;
    }

    @Override
    public List<StandardId> getStandardIdList() {
        return standardIdList;
    }

    @Override
    public Optional<String> getLinkedStimulusId() {
        return Optional.ofNullable(linkedStimulusId);
    }
}
