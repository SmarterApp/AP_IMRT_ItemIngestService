package org.opentestsystem.ap.imrt.iis.model;

import org.apache.commons.lang.StringUtils;
import org.opentestsystem.ap.common.model.AbstractAssessmentItemCore;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.ItemMetadata;
import org.opentestsystem.ap.common.model.StimItemCore;
import org.opentestsystem.ap.imrt.common.model.BaseItem;
import org.opentestsystem.ap.imrt.common.model.ImrtItem;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.common.model.ItemLog;
import org.opentestsystem.ap.imrt.common.model.ItemLogKey;
import org.opentestsystem.ap.imrt.common.model.Stimulus;

import java.util.Optional;

import static org.springframework.util.StringUtils.isEmpty;

/**
 * Implementation of ItemRevision interface that converts from AP common domain
 * model, with some associated git information, into IMRT domain model objects
 */
public final class ItemRevisionImpl implements ItemRevision {
    private final Item item;
    private final ItemBankItemRevision itemBankItemRevision;
    private final ItemGitInformation existingItemGitInformation;
    private ItemMetadata metadata;
    private BaseItem baseItem;
    private ItemGitInformation itemGitInformation;
    private String linkedStimulusId;
    private ItemLog itemLog;

    public ItemRevisionImpl(ItemBankItemRevision itemBankItemRevision, ItemGitInformation existingItemGitInformation) {
        this.item = itemBankItemRevision.getItem();
        this.existingItemGitInformation = existingItemGitInformation;
        this.itemBankItemRevision = itemBankItemRevision;

        createDomainModelObjects();
    }

    /**
     * Covert item bank data into domain model objects
     */
    private void createDomainModelObjects() {
        findMetadata();
        createImrtItem();
        createItemGitInformation();
        updateItemStandardIds(baseItem);
        createItemLog();
    }

    /**
     * Finds the ItemMetadata by inspecting the type of the item. Stores it
     * in the metadata field. Also stores linkedStimulusId if found.
     */
    private void findMetadata() {
        if (item.getCore() instanceof AbstractAssessmentItemCore) {
            AbstractAssessmentItemCore core = (AbstractAssessmentItemCore) item.getCore();
            metadata = core.getMetadata();
            String stimulusId = core.getStimulusId();
            if (!isEmpty(stimulusId)) {
                linkedStimulusId = stimulusId;
            }
        } else if (item.getCore() instanceof StimItemCore) {
            metadata = item.getCore().getMetadata();
        }
    }

    /**
     * Creates an ImrtItem from the item bank data and stores it in the
     * baseItem field.
     */
    private void createImrtItem() {
        baseItem = ItemConstants.ItemType.TYPE_STIM.equals(item.getType()) ? new Stimulus() : new ImrtItem();
        baseItem.setItemJson(item);
        baseItem.setId(item.getId());
        baseItem.setItemType(item.getType());
        baseItem.setUpdatedBy(itemBankItemRevision.getAuthor());
        baseItem.setAssociatedStimulusId(linkedStimulusId);
        baseItem.setBeingCreated(itemBankItemRevision.isBeingCreated());

        if (item.getWorkflow() != null) {
            baseItem.setWorkflowStatus(StringUtils.defaultString(item.getWorkflow().getWorkflowStatusCode()));
        }

        // Metadata may be null if this is a tutorial item
        if (metadata != null) {
            baseItem.setSubject(StringUtils.defaultString(metadata.getSubject()));
            baseItem.setGrade(StringUtils.defaultString(metadata.getGrade()));
            baseItem.setDepthOfKnowledge(StringUtils.defaultString(metadata.getDepthOfKnowledge()));
            baseItem.setOrganizationTypeId(StringUtils.defaultString(metadata.getOrganizationTypeId()));
            baseItem.setOrganizationName(StringUtils.defaultString(metadata.getOrganizationName()));
            baseItem.setContentTaskModel(StringUtils.defaultString(metadata.getContentTaskModel()));
            baseItem.setItemAuthor(metadata.getItemAuthor());
        }
        if (null == existingItemGitInformation) {
            // We have never seen this item before, so set the creation info from this commit
            baseItem.setItemCreatedBy(itemBankItemRevision.getAuthor());
            baseItem.setItemCreatedAt(itemBankItemRevision.getRevisionDate());
            baseItem.setWorkflowStatusSetAt(itemBankItemRevision.getRevisionDate());
        } else {
            BaseItem existingImrtItem = existingItemGitInformation.getItem();
            baseItem.setItemCreatedBy(existingImrtItem.getItemCreatedBy());
            baseItem.setItemCreatedAt(existingImrtItem.getItemCreatedAt());
            baseItem.setWorkflowStatusSetAt(existingImrtItem.getWorkflowStatusSetAt());
            baseItem.setKey(existingImrtItem.getKey());
        }
    }

    /**
     * Creates ItemGitInformation from the item bank data and stores it in
     * the itemGitInformation field
     */
    private void createItemGitInformation() {
        itemGitInformation = new ItemGitInformation();
        itemGitInformation.setItem(baseItem);
        itemGitInformation.setProjectId(itemBankItemRevision.getItemBankId());
        itemGitInformation.setProjectPath(itemBankItemRevision.getItemBankPath());
        itemGitInformation.setCurrentCommitDate(itemBankItemRevision.getRevisionDate());
        itemGitInformation.setCurrentCommitHash(itemBankItemRevision.getRevisionId());
        itemGitInformation.setUpdatedBy(itemBankItemRevision.getAuthor());
        itemGitInformation.setIngestSource(itemBankItemRevision.getIngestSource());
    }

    private void updateItemStandardIds(BaseItem item) {
        if (null == metadata) {
            return;
        }

        item.setPrimaryClaim(StringUtils.defaultString(metadata.getPrimaryClaim()));
        item.setPrimaryTarget(StringUtils.defaultString(metadata.getPrimaryAssessmentTarget()));

        item.setPrimaryCommonCoreStandard(StringUtils.defaultString(metadata.getPrimaryCommonCoreStandard()));

        //ELA content domain is stored in a different field than MATH
        if (ItemConstants.ItemSubject.SUBJECT_ELA.equalsIgnoreCase(metadata.getSubject())) {
            item.setPrimaryContentDomain(StringUtils.defaultString(metadata.getContentDomain()));
        } else {
            item.setPrimaryContentDomain(StringUtils.defaultString(metadata.getPrimaryContentDomain()));
        }

        updateNonPrimaryStandardIds(item);
    }

    private void updateNonPrimaryStandardIds(BaseItem item) {
        item.setSecondaryClaim(StringUtils.defaultString(metadata.getSecondaryClaim()));
        item.setSecondaryCommonCoreStandard(StringUtils.defaultString(metadata.getSecondaryCommonCoreStandard()));
        item.setSecondaryContentDomain(StringUtils.defaultString(metadata.getSecondaryContentDomain()));
        item.setSecondaryTarget(StringUtils.defaultString(metadata.getSecondaryAssessmentTarget()));
        item.setTertiaryClaim(StringUtils.defaultString(metadata.getTertiaryClaim()));
        item.setTertiaryCommonCoreStandard(StringUtils.defaultString(metadata.getTertiaryCommonCoreStandard()));
        item.setTertiaryContentDomain(StringUtils.defaultString(metadata.getTertiaryContentDomain()));
        item.setTertiaryTarget(StringUtils.defaultString(metadata.getTertiaryAssessmentTarget()));
        item.setQuaternaryClaim(StringUtils.defaultString(metadata.getQuaternaryClaim()));
        item.setQuaternaryCommonCoreStandard(StringUtils.defaultString(metadata.getQuaternaryCommonCoreStandard()));
        item.setQuaternaryContentDomain(StringUtils.defaultString(metadata.getQuaternaryContentDomain()));
        item.setQuaternaryTarget(StringUtils.defaultString(metadata.getQuaternaryAssessmentTarget()));
    }

    /**
     * Create an itemLog entry for this revision
     */
    private void createItemLog() {
        ItemLogKey itemLogKey = new ItemLogKey(baseItem, itemBankItemRevision.getRevisionId());
        itemLog = new ItemLog();
        itemLog.setItemLogKey(itemLogKey);
        itemLog.setCommitDate(itemBankItemRevision.getRevisionDate());
        itemLog.setUpdatedBy(itemBankItemRevision.getAuthor());
        itemLog.setIngestSource(itemBankItemRevision.getIngestSource());
    }

    @Override
    public ItemGitInformation getItemGitInformation() {
        return itemGitInformation;
    }

    @Override
    public BaseItem getItem() {
        return baseItem;
    }

    @Override
    public Optional<String> getLinkedStimulusId() {
        return Optional.ofNullable(linkedStimulusId);
    }

    @Override
    public ItemLog getItemLog() {
        return itemLog;
    }
}
