package org.opentestsystem.ap.imrt.iis.model;

import com.google.common.primitives.Ints;
import org.apache.commons.lang.StringUtils;
import org.opentestsystem.ap.common.model.AbstractAssessmentItemCore;
import org.opentestsystem.ap.common.model.Administration;
import org.opentestsystem.ap.common.model.AssessmentItemCore;
import org.opentestsystem.ap.common.model.FieldTestData;
import org.opentestsystem.ap.common.model.Form;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.ItemMetadata;
import org.opentestsystem.ap.common.model.TestAdministration;
import org.opentestsystem.ap.imrt.common.model.Attachment;
import org.opentestsystem.ap.imrt.common.model.AttachmentFileTypes;
import org.opentestsystem.ap.imrt.common.model.AttachmentKey;
import org.opentestsystem.ap.imrt.common.model.BaseItem;
import org.opentestsystem.ap.imrt.common.model.ImrtItem;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.common.model.ItemLog;
import org.opentestsystem.ap.imrt.common.model.ItemLogKey;
import org.opentestsystem.ap.imrt.common.model.Stimulus;

import java.util.ArrayList;
import java.util.List;
import java.util.Optional;
import java.util.Set;
import java.util.stream.Collectors;

import static org.apache.commons.lang.StringUtils.isNotBlank;
import static org.springframework.util.StringUtils.isEmpty;

/**
 * Implementation of ItemRevision interface that converts from AP common domain
 * model, with some associated git information, into IMRT domain model objects
 */
public final class ItemRevisionImpl implements ItemRevision {
    private ItemRevision itemRevision;

    public ItemRevisionImpl(ItemBankItemRevision itemBankItemRevision,
                            ItemGitInformation existingItemGitInformation) {
        this.itemRevision = convert(itemBankItemRevision, existingItemGitInformation);
    }

    public ItemRevisionImpl() {
    }

    public ItemRevision convert(ItemBankItemRevision itemBankItemRevision, ItemGitInformation existingItemGitInformation) {
        Item item = itemBankItemRevision.getItem();
        ItemInformation itemInformation = getItemInformation(item);
        BaseItem baseItem = createBaseItem(itemInformation, existingItemGitInformation, itemBankItemRevision);
        ItemGitInformation itemGitInformation = createItemGitInformation(baseItem, itemBankItemRevision);
        ItemLog itemLog = createItemLog(baseItem, itemBankItemRevision);

        return ItemRevisionModel.builder()
                .withBaseItem(baseItem)
                .withItemGitInformation(itemGitInformation)
                .withItemLog(itemLog)
                .withLinkedStimulusId(itemInformation.getStimulusId().orElse(null))
                .withExistingItem(existingItemGitInformation != null)
                .build();
    }

    /**
     * Finds the ItemMetadata by inspecting the type of the item. Stores it
     * in the metadata field. Also stores linkedStimulusId if found.
     */
    private ItemInformation getItemInformation(Item item) {
        if (item.getCore() instanceof AbstractAssessmentItemCore) {
            AbstractAssessmentItemCore core = (AbstractAssessmentItemCore) item.getCore();
            ItemMetadata metadata = core.getMetadata();
            String stimulusId = core.getStimulusId();
            Integer linkedStimulusId = null;
            if (!isEmpty(stimulusId)) {
                linkedStimulusId = convertItemId(stimulusId);
            }

            return new ItemInformation(item, metadata, linkedStimulusId);
        } else if (item.getCore() != null) {
            ItemMetadata metadata = item.getCore().getMetadata();
            return new ItemInformation(item, metadata);
        }

        return new ItemInformation(item, null, null);
    }

    /**
     * Creates an ImrtItem from the item bank data and stores it in the
     * baseItem field.
     */
    private BaseItem createBaseItem(final ItemInformation itemInformation,
                                    final ItemGitInformation existingItemGitInformation,
                                    final ItemBankItemRevision itemBankItemRevision) {
        final Item item = itemInformation.getItem();
        BaseItem baseItem = ItemConstants.ItemType.TYPE_STIM.equals(item.getType()) ? new Stimulus() : new ImrtItem();

        baseItem.setId(convertItemId(item.getId()));
        baseItem.setItemJson(item);
        baseItem.setItemType(item.getType());
        baseItem.setUpdatedBy(itemBankItemRevision.getAuthor());
        baseItem.setBeingCreated(itemBankItemRevision.isBeingCreated());

        if (itemInformation.getStimulusId().isPresent()) {
            baseItem.setAssociatedStimulusId(itemInformation.getStimulusId().get());
        }

        if (item.getWorkflow() != null) {
            baseItem.setWorkflowStatus(StringUtils.defaultString(item.getWorkflow().getWorkflowStatusCode()));
        }

        // Metadata may be null if this is a tutorial item
        if (itemInformation.getItemMetadata().isPresent()) {
            ItemMetadata metadata = itemInformation.getItemMetadata().get();
            baseItem.setSubject(StringUtils.defaultString(metadata.getSubject()));
            baseItem.setGrade(StringUtils.defaultString(metadata.getIntendedGrade()));
            baseItem.setDepthOfKnowledge(StringUtils.defaultString(metadata.getDepthOfKnowledge()));
            baseItem.setOrganizationTypeId(StringUtils.defaultString(metadata.getOrganizationTypeId()));
            baseItem.setOrganizationName(StringUtils.defaultString(metadata.getOrganizationName()));
            baseItem.setContentTaskModel(StringUtils.defaultString(metadata.getContentTaskModel()));
            baseItem.setPerformanceTask(StringUtils.defaultString(metadata.getPerformanceTask()));
            baseItem.setWritingPurpose(StringUtils.defaultString(metadata.getWritingPurpose()));
            baseItem.setItemAuthor(metadata.getItemAuthor());
        }
        if (null == existingItemGitInformation) {
            // We have never seen this item before, so set the creation info from this commit
            baseItem.setItemCreatedBy(itemBankItemRevision.getAuthor());
            baseItem.setItemCreatedAt(itemBankItemRevision.getRevisionDate());
            baseItem.setWorkflowStatusSetAt(itemBankItemRevision.getRevisionDate());
        } else {
            BaseItem existingImrtItem = existingItemGitInformation.getItem();
            baseItem.setItemCreatedBy(existingImrtItem.getItemCreatedBy());
            baseItem.setItemCreatedAt(existingImrtItem.getItemCreatedAt());
            baseItem.setWorkflowStatusSetAt(existingImrtItem.getWorkflowStatusSetAt());
            baseItem.setKey(existingImrtItem.getKey());
        }

        if (item.getTextToSpeech() != null) {
            baseItem.setVisualTtsRequired(StringUtils.defaultString(item.getTextToSpeech().getVisualTTSRequired()));
            baseItem.setVisualTtsProvided(item.getTextToSpeech().isVisualTTSProvided());
            baseItem.setSightTtsProvided(item.getTextToSpeech().isSightTTSProvided());
        }

        populateItemWithAdministrationData(item, baseItem);
        populateItemWithContentRequiredData(item, baseItem);
        updateItemStandardIds(baseItem, itemInformation);

        return baseItem;
    }

    /**
     * Set the content required fields for the {@link org.opentestsystem.ap.imrt.common.model.BaseItem}.
     */
    private void populateItemWithContentRequiredData(final Item item, final BaseItem baseItem) {
        if (item.getAsl() != null) {
            baseItem.setAslRequired(StringUtils.defaultString(item.getAsl().getAslRequired()));
            baseItem.setAslProvided(String.valueOf(item.getAsl().isAslProvided()));
            baseItem.setAslAttachments(getContentAttachments(baseItem,
                    item.getAsl().getAttachments(),
                    AttachmentFileTypes.ASL));
        }

        if (item.getBraille() != null) {
            baseItem.setBrailleRequired(item.getBraille().getBrailleRequired());
            baseItem.setBrailleProvided(String.valueOf(item.getBraille().isBrailleProvided()));
            baseItem.setBrailleAttachments(getContentAttachments(baseItem,
                    item.getBraille().getAttachments(),
                    AttachmentFileTypes.BRAILLE));
        }

        if (item.getCc() != null) {
            baseItem.setCcRequired(item.getCc().getCcRequired());
            baseItem.setCcProvided(String.valueOf(item.getCc().isCcProvided()));
            baseItem.setCcAttachments(getContentAttachments(baseItem,
                    item.getCc().getAttachments(),
                    AttachmentFileTypes.CC));
        }

        if (item.getTranslations() != null) {
            baseItem.setTranslationRequired(item.getTranslations().getEsp().isRequired());
            baseItem.setTranslationProvided(String.valueOf(item.getTranslations().getEsp().isProvided()));
        }
    }

    /**
     * Creates ItemGitInformation from the item bank data and stores it in
     * the itemGitInformation field
     */
    private ItemGitInformation createItemGitInformation(BaseItem baseItem, ItemBankItemRevision itemBankItemRevision) {
        ItemGitInformation itemGitInformation = new ItemGitInformation();
        itemGitInformation.setItem(baseItem);
        itemGitInformation.setProjectId(itemBankItemRevision.getItemBankId());
        itemGitInformation.setProjectPath(itemBankItemRevision.getItemBankPath());
        itemGitInformation.setCurrentCommitDate(itemBankItemRevision.getRevisionDate());
        itemGitInformation.setCurrentCommitHash(itemBankItemRevision.getRevisionId());
        itemGitInformation.setUpdatedBy(itemBankItemRevision.getAuthor());
        itemGitInformation.setIngestSource(itemBankItemRevision.getIngestSource());

        return itemGitInformation;
    }

    private void updateItemStandardIds(BaseItem item, ItemInformation itemInformation) {
        if (!itemInformation.getItemMetadata().isPresent()) {
            return;
        }

        final ItemMetadata metadata = itemInformation.getItemMetadata().get();

        item.setPrimaryClaim(StringUtils.defaultString(metadata.getPrimaryClaim()));
        item.setPrimaryTarget(StringUtils.defaultString(metadata.getPrimaryTarget()));
        item.setPrimaryCommonCoreStandard(StringUtils.defaultString(metadata.getPrimaryCommonCoreStandard()));
        item.setPrimaryContentDomain(StringUtils.defaultString(metadata.getPrimaryContentDomain()));
        item.setSecondaryClaim(StringUtils.defaultString(metadata.getSecondaryClaim()));
        item.setSecondaryCommonCoreStandard(StringUtils.defaultString(metadata.getSecondaryCommonCoreStandard()));
        item.setSecondaryContentDomain(StringUtils.defaultString(metadata.getSecondaryContentDomain()));
        item.setSecondaryTarget(StringUtils.defaultString(metadata.getSecondaryTarget()));
        item.setTertiaryClaim(StringUtils.defaultString(metadata.getTertiaryClaim()));
        item.setTertiaryCommonCoreStandard(StringUtils.defaultString(metadata.getTertiaryCommonCoreStandard()));
        item.setTertiaryContentDomain(StringUtils.defaultString(metadata.getTertiaryContentDomain()));
        item.setTertiaryTarget(StringUtils.defaultString(metadata.getTertiaryTarget()));
        item.setQuaternaryClaim(StringUtils.defaultString(metadata.getQuaternaryClaim()));
        item.setQuaternaryCommonCoreStandard(StringUtils.defaultString(metadata.getQuaternaryCommonCoreStandard()));
        item.setQuaternaryContentDomain(StringUtils.defaultString(metadata.getQuaternaryContentDomain()));
        item.setQuaternaryTarget(StringUtils.defaultString(metadata.getQuaternaryTarget()));
    }

    private void populateItemWithAdministrationData(Item item, BaseItem baseItem) {
        if (!(item.getCore() instanceof AssessmentItemCore)) {
            baseItem.setExposuresCount(null);
            baseItem.setFormCount(null);
            baseItem.setItemDifficultyQuintile(null);
            return;
        }

        TestAdministration testAdministration = ((AssessmentItemCore) item.getCore()).getTestAdministration();

        //If the item has not been included in an administration them we cannot capture the data.
        if (testAdministration == null
                || testAdministration.getAdministrations() == null
                || testAdministration.getAdministrations().isEmpty()) {
            baseItem.setExposuresCount(null);
            baseItem.setFormCount(null);
            baseItem.setItemDifficultyQuintile(null);
            return;
        }

        final String fieldTestDataId = testAdministration.getFieldTestAdministrationId();
        int exposuresCount = 0;
        Optional<FieldTestData> fieldTestData = Optional.empty();
        List<org.opentestsystem.ap.imrt.common.model.Form> forms = new ArrayList<>();

        for (Administration administration : testAdministration.getAdministrations()) {
            if (StringUtils.equals(administration.getAdministrationId(), fieldTestDataId)) {
                fieldTestData = Optional.of(administration.getFieldTestData());
            }

            for (Form form : administration.getForms()) {
                if (form.getExposures() != null) {
                    exposuresCount += form.getExposures();
                }

                org.opentestsystem.ap.imrt.common.model.Form itemForm = new org.opentestsystem.ap.imrt.common.model.Form();
                itemForm.setFormId(form.getFormId());
                itemForm.setFormType(form.getFormType());
                itemForm.setAssessmentType(form.getAssessmentType());
                itemForm.setExposures(form.getExposures());
                itemForm.setItem(baseItem);
                itemForm.setUpdatedBy(baseItem.getUpdatedBy());
                forms.add(itemForm);
            }
        }

        baseItem.setExposuresCount(exposuresCount);
        baseItem.setFormCount(forms.size());
        baseItem.setForms(forms);

        if (fieldTestData.isPresent() && isNotBlank(fieldTestData.get().getItemDifficultyQuintile())) {
            baseItem.setItemDifficultyQuintile(Ints.tryParse(fieldTestData.get().getItemDifficultyQuintile()));
        }
    }

    /**
     * Create an itemLog entry for this revision
     */
    private ItemLog createItemLog(BaseItem baseItem, ItemBankItemRevision itemBankItemRevision) {
        ItemLogKey itemLogKey = new ItemLogKey(baseItem, itemBankItemRevision.getRevisionId());
        ItemLog itemLog = new ItemLog();
        itemLog.setItemLogKey(itemLogKey);
        itemLog.setCommitDate(itemBankItemRevision.getRevisionDate());
        itemLog.setUpdatedBy(itemBankItemRevision.getAuthor());
        itemLog.setIngestSource(itemBankItemRevision.getIngestSource());

        return itemLog;
    }

    /**
     * Converts IAT's string ids to numeric ids
     *
     * @param id the id String to be converted
     * @return the integer id
     * @throws IllegalArgumentException if the id is not a number
     */
    private static Integer convertItemId(String id) throws IllegalArgumentException {
        try {
            return Integer.valueOf(id);
        } catch (NumberFormatException nfe) {
            throw new IllegalArgumentException("The id is not a number and cannot be ingested into the system");
        }
    }

    /**
     * Map a collection of {@link org.opentestsystem.ap.common.model.Attachment}s to a collection of
     * {@link org.opentestsystem.ap.imrt.common.model.Attachment}s from the collection
     *
     * @param item           The {@link org.opentestsystem.ap.imrt.common.model.BaseItem} being stored in the database
     * @param iatAttachments The collection of {@link org.opentestsystem.ap.common.model.Attachment}s to map
     * @param fileType       The type of file being mapped
     * @return A {@link java.util.Set<org.opentestsystem.ap.imrt.common.model.Attachment>} representing the content
     * attachments from IAT.
     */
    private Set<Attachment> getContentAttachments(final BaseItem item,
                                                  final List<org.opentestsystem.ap.common.model.Attachment> iatAttachments,
                                                  final String fileType) {
        return iatAttachments.stream()
                .map(attachment -> new Attachment(new AttachmentKey(item, attachment.getFileName(), fileType),
                        attachment.getUploadedDate().toInstant(),
                        item.getUpdatedBy()))
                .collect(Collectors.toSet());
    }

    @Override
    public ItemGitInformation getItemGitInformation() {
        return itemRevision.getItemGitInformation();
    }

    @Override
    public BaseItem getItem() {
        return itemRevision.getItem();
    }

    @Override
    public Optional<Integer> getLinkedStimulusId() {
        return itemRevision.getLinkedStimulusId();
    }

    @Override
    public ItemLog getItemLog() {
        return itemRevision.getItemLog();
    }

    @Override
    public boolean isExistingItem() {
        return itemRevision.isExistingItem();
    }

    private static class ItemInformation {
        final Item item;
        final ItemMetadata itemMetadata;
        final Integer stimulusId;

        ItemInformation(final Item item, final ItemMetadata itemMetadata, final Integer stimulusId) {
            this.item = item;
            this.itemMetadata = itemMetadata;
            this.stimulusId = stimulusId;
        }

        ItemInformation(final Item item, final ItemMetadata itemMetadata) {
            this(item, itemMetadata, null);
        }

        ItemInformation(final Item item) {
            this(item, null, null);
        }

        public Item getItem() {
            return item;
        }

        public Optional<ItemMetadata> getItemMetadata() {
            return Optional.ofNullable(itemMetadata);
        }

        public Optional<Integer> getStimulusId() {
            return Optional.ofNullable(stimulusId);
        }
    }
}
