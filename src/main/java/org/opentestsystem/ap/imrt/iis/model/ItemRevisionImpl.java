package org.opentestsystem.ap.imrt.iis.model;

import com.google.common.collect.Lists;
import org.apache.commons.lang.StringUtils;
import org.opentestsystem.ap.common.model.AbstractAssessmentItemCore;
import org.opentestsystem.ap.common.model.Item;
import org.opentestsystem.ap.common.model.ItemConstants;
import org.opentestsystem.ap.common.model.ItemMetadata;
import org.opentestsystem.ap.common.model.StimItemCore;
import org.opentestsystem.ap.imrt.common.model.BaseItem;
import org.opentestsystem.ap.imrt.common.model.ImrtItem;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.common.model.ItemLog;
import org.opentestsystem.ap.imrt.common.model.ItemLogKey;
import org.opentestsystem.ap.imrt.common.model.StandardId;
import org.opentestsystem.ap.imrt.common.model.StandardIdKey;
import org.opentestsystem.ap.imrt.common.model.Stimulus;

import java.time.Instant;
import java.util.List;
import java.util.Optional;

import static org.springframework.util.StringUtils.isEmpty;

/**
 * Implementation of ItemRevision interface that converts from AP common domain
 * model, with some associated git information, into IMRT domain model objects
 */
public final class ItemRevisionImpl implements ItemRevision {
    private final Item item;
    private final int gitId;
    private final String gitPath;
    private final String revisionId;
    private final Instant revisionDate;
    private final String author;
    private final ItemGitInformation existingItemGitInformation;
    private ItemMetadata metadata;
    private BaseItem baseItem;
    private ItemGitInformation itemGitInformation;
    private String linkedStimulusId;
    private final List<StandardId> standardIdList = Lists.newArrayList();
    private ItemLog itemLog;

    public ItemRevisionImpl(ItemBankItemRevision itemBankItemRevision, ItemGitInformation existingItemGitInformation) {
        this.item = itemBankItemRevision.getItem();
        this.gitId = itemBankItemRevision.getItemBankId();
        this.gitPath = itemBankItemRevision.getItemBankPath();
        this.revisionId = itemBankItemRevision.getRevisionId();
        this.revisionDate = itemBankItemRevision.getRevisionDate();
        this.author = itemBankItemRevision.getAuthor();
        this.existingItemGitInformation = existingItemGitInformation;

        createDomainModelObjects();
    }

    /**
     * Covert item bank data into domain model objects
     */
    private void createDomainModelObjects() {
        findMetadata();
        createImrtItem();
        createItemGitInformation();
        createStandardIds();
        createItemLog();
    }

    /**
     * Finds the ItemMetadata by inspecting the type of the item. Stores it
     * in the metadata field. Also stores linkedStimulusId if found.
     */
    private void findMetadata() {
        if (item.getCore() instanceof AbstractAssessmentItemCore) {
            AbstractAssessmentItemCore core = (AbstractAssessmentItemCore) item.getCore();
            metadata = core.getMetadata();
            String stimulusId = core.getStimulusId();
            if (!isEmpty(stimulusId)) {
                linkedStimulusId = stimulusId;
            }
        } else if (item.getCore() instanceof StimItemCore) {
            metadata = ((StimItemCore) item.getCore()).getMetadata();
        }
    }

    /**
     * Creates an ImrtItem from the item bank data and stores it in the
     * baseItem field.
     */
    private void createImrtItem() {
        baseItem = ItemConstants.ItemType.TYPE_STIM.equals(item.getType()) ? new Stimulus() : new ImrtItem();
        baseItem.setItemJson(item);
        baseItem.setId(item.getId());
        baseItem.setItemType(item.getType());
        baseItem.setUpdatedBy(author);
        baseItem.setAssociatedStimulusId(linkedStimulusId);

        if(item.getWorkflow() != null) {
            baseItem.setWorkflowStatus(item.getWorkflow().getWorkflowStatusCode());
        }

        // Metadata may be null if this is a tutorial item
        if (metadata != null) {
            baseItem.setSubject(metadata.getSubject());
            baseItem.setGrade(metadata.getGrade() == null ? StringUtils.EMPTY : metadata.getGrade());
            baseItem.setDepthOfKnowledge(metadata.getDepthOfKnowledge());
        }
        if (null == existingItemGitInformation) {
            // We have never seen this item before, so set the creation info from this commit
            baseItem.setItemCreatedBy(author);
            baseItem.setItemCreatedAt(revisionDate);
        } else {
            BaseItem existingImrtItem = existingItemGitInformation.getItem();
            baseItem.setItemCreatedBy(existingImrtItem.getItemCreatedBy());
            baseItem.setItemCreatedAt(existingImrtItem.getItemCreatedAt());
            baseItem.setKey(existingImrtItem.getKey());
        }
    }

    /**
     * Creates ItemGitInformation from the item bank data and stores it in
     * the itemGitInformation field
     */
    private void createItemGitInformation() {
        itemGitInformation = new ItemGitInformation();
        itemGitInformation.setItem(baseItem);
        itemGitInformation.setProjectId(gitId);
        itemGitInformation.setProjectPath(gitPath);
        itemGitInformation.setCurrentCommitDate(revisionDate);
        itemGitInformation.setCurrentCommitHash(revisionId);
        itemGitInformation.setUpdatedBy(author);
    }

    /**
     * Creates the standardId objects if the associated data is present.
     * Standard Ids are stored in the standardId list field.
     */
    private void createStandardIds() {
        if (null == metadata) {
            return;
        }
        // Standard IDs are handled a bit differently for ELA than for other subjects
        if (ItemConstants.ItemSubject.SUBJECT_ELA.equalsIgnoreCase(metadata.getSubject())) {
            createElaStandardId();
        } else {
            createNormalStandardIds();
        }
    }

    /**
     * Create a standard id domain object based on the current method IAT uses for ELA.
     * The id is only created if at least one value is populated. The id is stored
     * in the standardId list field.
     */
    private void createElaStandardId() {
        if (anyFieldsPopulated(metadata.getPrimaryClaim(),
                metadata.getContentDomain(), metadata.getPrimaryAssessmentTarget(),
                // TODO when supported metadata.getPrimaryEmphasis
                metadata.getPrimaryCommonCoreStandard())) {
            standardIdList.add(new StandardId.StandardIdBuilder()
                    .withStandardIdKey(new StandardIdKey(baseItem, StandardIdKey.PRIMARY))
                    .withClaim(metadata.getPrimaryClaim())
                    .withContentDomain(metadata.getContentDomain())
                    .withTarget(metadata.getPrimaryAssessmentTarget())
                    .withEmphasis("")  //TODO - IAT required to populate this information
                    .withCommonCoreStandard(metadata.getPrimaryCommonCoreStandard())
                    .withUpdatedBy(author)
                    .build());
        }
    }

    /**
     * Create standard id domain objects based on the primary, secondary, tertiary, and quaternay values
     * in the item metadata. Ids are only created if at least one value is populated. Standard ids are stored
     * in the standardIdList field.
     */
    private void createNormalStandardIds() {
        if (anyFieldsPopulated(metadata.getPrimaryClaim(),
                metadata.getPrimaryContentDomain(), metadata.getPrimaryAssessmentTarget(),
                // TODO when supported metadata.getPrimaryEmphasis
                metadata.getPrimaryCommonCoreStandard())) {
            standardIdList.add(new StandardId.StandardIdBuilder()
                    .withStandardIdKey(new StandardIdKey(baseItem, StandardIdKey.PRIMARY))
                    .withClaim(metadata.getPrimaryClaim())
                    .withContentDomain(metadata.getPrimaryContentDomain())
                    .withTarget(metadata.getPrimaryAssessmentTarget())
                    .withEmphasis("")  //TODO - IAT required to populate this information
                    .withCommonCoreStandard(metadata.getPrimaryCommonCoreStandard())
                    .withUpdatedBy(author)
                    .build());
        }
        if (anyFieldsPopulated(metadata.getSecondaryClaim(),
                metadata.getSecondaryContentDomain(), metadata.getSecondaryAssessmentTarget(),
                metadata.getSecondaryCommonCoreStandard())) {
            standardIdList.add(new StandardId.StandardIdBuilder()
                    .withStandardIdKey(new StandardIdKey(baseItem, StandardIdKey.SECONDARY))
                    .withClaim(metadata.getSecondaryClaim())
                    .withContentDomain(metadata.getSecondaryContentDomain())
                    .withTarget(metadata.getSecondaryAssessmentTarget())
                    .withCommonCoreStandard(metadata.getSecondaryCommonCoreStandard())
                    .withUpdatedBy(author)
                    .build());
        }
        if (anyFieldsPopulated(metadata.getTertiaryClaim(),
                metadata.getTertiaryContentDomain(), metadata.getTertiaryAssessmentTarget(),
                metadata.getTertiaryCommonCoreStandard())) {
            standardIdList.add(new StandardId.StandardIdBuilder()
                    .withStandardIdKey(new StandardIdKey(baseItem, StandardIdKey.TERTIARY))
                    .withClaim(metadata.getTertiaryClaim())
                    .withContentDomain(metadata.getTertiaryContentDomain())
                    .withTarget(metadata.getTertiaryAssessmentTarget())
                    .withCommonCoreStandard(metadata.getTertiaryCommonCoreStandard())
                    .withUpdatedBy(author)
                    .build());
        }
        if (anyFieldsPopulated(metadata.getQuaternaryClaim(),
                metadata.getQuaternaryContentDomain(), metadata.getQuaternaryAssessmentTarget(),
                metadata.getQuaternaryCommonCoreStandard())) {
            standardIdList.add(new StandardId.StandardIdBuilder()
                    .withStandardIdKey(new StandardIdKey(baseItem, StandardIdKey.QUATERNARY))
                    .withClaim(metadata.getQuaternaryClaim())
                    .withContentDomain(metadata.getQuaternaryContentDomain())
                    .withTarget(metadata.getQuaternaryAssessmentTarget())
                    .withCommonCoreStandard(metadata.getQuaternaryCommonCoreStandard())
                    .withUpdatedBy(author)
                    .build());
        }
    }

    /**
     * Null safe checking on a set of fields to see if any of them are populated
     *
     * @param fields the set of fields to check
     * @return true if all fields are empty, false otherwise
     */
    private boolean anyFieldsPopulated(String... fields) {
        for (String field : fields) {
            if (!isEmpty(field)) {
                return true;
            }
        }
        return false;
    }

    /**
     * Create an itemLog entry for this revision
     */
    private void createItemLog() {
        ItemLogKey itemLogKey = new ItemLogKey(baseItem, revisionId);
        itemLog = new ItemLog();
        itemLog.setItemLogKey(itemLogKey);
        itemLog.setCommitDate(revisionDate);
        itemLog.setUpdatedBy(author);
    }

    @Override
    public ItemGitInformation getItemGitInformation() {
        return itemGitInformation;
    }

    @Override
    public BaseItem getItem() {
        return baseItem;
    }

    @Override
    public List<StandardId> getStandardIdList() {
        return standardIdList;
    }

    @Override
    public Optional<String> getLinkedStimulusId() {
        return Optional.ofNullable(linkedStimulusId);
    }

    @Override
    public ItemLog getItemLog() {
        return itemLog;
    }
}
