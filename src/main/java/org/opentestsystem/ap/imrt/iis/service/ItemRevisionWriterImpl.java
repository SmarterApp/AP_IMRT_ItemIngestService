package org.opentestsystem.ap.imrt.iis.service;

import org.opentestsystem.ap.imrt.common.model.BaseItem;
import org.opentestsystem.ap.imrt.common.model.ImrtItem;
import org.opentestsystem.ap.imrt.common.model.ItemGitInformation;
import org.opentestsystem.ap.imrt.common.model.StandardId;
import org.opentestsystem.ap.imrt.common.model.StandardIdKey;
import org.opentestsystem.ap.imrt.common.model.Stimulus;
import org.opentestsystem.ap.imrt.common.model.StimulusLink;
import org.opentestsystem.ap.imrt.common.repository.ImrtItemRepository;
import org.opentestsystem.ap.imrt.common.repository.StimulusLinkRepository;
import org.opentestsystem.ap.imrt.common.repository.StimulusRepository;
import org.opentestsystem.ap.imrt.common.service.OperationalEventService;
import org.opentestsystem.ap.imrt.iis.model.ItemRevision;
import org.opentestsystem.ap.imrt.iis.repository.ItemGitInformationRepository;
import org.opentestsystem.ap.imrt.iis.repository.ItemLogRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.stereotype.Service;
import org.springframework.transaction.annotation.Transactional;

import java.util.List;
import java.util.Optional;
import java.util.stream.Collectors;

/**
 * Implementation of ItemRevisionWriter interface that stores the various parts of an item revision
 * to the appropriate respositories in a single transaction, to ensure foreign key consistency.
 */
@Service
public class ItemRevisionWriterImpl implements ItemRevisionWriter {
    private static final Logger logger = LoggerFactory.getLogger(ItemRevisionWriterImpl.class);

    private final ItemGitInformationRepository itemGitInformationRepository;
    private final ImrtItemRepository imrtItemRepository;
    private final StimulusLinkRepository stimulusLinkRepository;
    private final ItemLogRepository itemLogRepository;
    private final OperationalEventService operationalEventService;
    private final StimulusRepository stimulusRepository;

    public ItemRevisionWriterImpl(ItemGitInformationRepository itemGitInformationRepository,
                                  ImrtItemRepository imrtItemRepository,
                                  StimulusLinkRepository stimulusLinkRepository,
                                  ItemLogRepository itemLogRepository,
                                  OperationalEventService operationalEventService,
                                  StimulusRepository stimulusRepository) {
        this.itemGitInformationRepository = itemGitInformationRepository;
        this.imrtItemRepository = imrtItemRepository;
        this.stimulusLinkRepository = stimulusLinkRepository;
        this.itemLogRepository = itemLogRepository;
        this.operationalEventService = operationalEventService;
        this.stimulusRepository = stimulusRepository;
    }

    @Override
    @Transactional
    public void saveItemRevision(ItemRevision itemRevision) {
        // We always write the item and it's git information
        BaseItem item = itemRevision.getItem();
        ItemGitInformation itemGitInformation = itemRevision.getItemGitInformation();

        if(item instanceof Stimulus) {
            saveStimulus(itemRevision);
        } else {
            saveImrtItem(itemRevision);
        }

        itemGitInformationRepository.save(itemGitInformation);

        // Save the item log
        itemLogRepository.save(itemRevision.getItemLog());

        //TODO - Replace "projectId" with itemBankId or something equivalent once data model is updated
        logger.debug("Item saved to database. gitlab projectId: {} item id: {} database key {}",
                itemGitInformation.getProjectId(), item.getId(), item.getKey());
    }

    private void saveImrtItem(final ItemRevision itemRevision) {
        ImrtItem imrtItem = (ImrtItem) itemRevision.getItem();

        List<StandardId> standardIds = itemRevision.getStandardIdList();
        if(imrtItem.getKey() == null) {
            imrtItemRepository.save(imrtItem);

            for(StandardId standardId : standardIds) {
                StandardIdKey key = standardId.getStandardIdKey();
                standardId.setStandardIdKey(new StandardIdKey(imrtItem.getKey(), key.getType()));
            }
        }

        imrtItem.setStandardIds(itemRevision.getStandardIdList());
        imrtItemRepository.save(imrtItem);

        // Check for a linked stimulus
        Optional<String> linkedStimulusId = itemRevision.getLinkedStimulusId();
        if (linkedStimulusId.isPresent()) {
            Stimulus stimulus = stimulusRepository.findById(linkedStimulusId.get());
            if (null != stimulus) {
                StimulusLink stimLink = new StimulusLink(imrtItem, stimulus, imrtItem.getUpdatedBy());
                stimulusLinkRepository.save(stimLink);
            } else {
                operationalEventService.serviceWarning(logger, null, "Unable to find linked stimulus in database for item id {} stimulus id {}",
                        imrtItem.getId(), linkedStimulusId);
            }
        }
    }

    private void saveStimulus(final ItemRevision itemRevision) {
        Stimulus stimulus = (Stimulus) itemRevision.getItem();
        final Optional<Integer> maybeItemKey = Optional.ofNullable(itemRevision.getItem().getKey());

        List<StandardId> standardIds = itemRevision.getStandardIdList();
        if(stimulus.getKey() == null) {
            stimulusRepository.save(stimulus);

            standardIds.forEach(standardId -> {
                StandardIdKey key = standardId.getStandardIdKey();
                standardId.setStandardIdKey(new StandardIdKey(stimulus.getKey(), key.getType()));
            });
        }

        stimulus.setStandardIds(itemRevision.getStandardIdList());

        // If the key has not been set yet, then we are creating this stim
        // for the first time. We need to check and see if there are any items
        // that already reference it, and create/update the links for them.
        // We need to save the stimulus first, so a key gets assigned. Then
        // we can use the key when creating/updating the link
        final Stimulus savedStimulus = stimulusRepository.save(stimulus);
        if (!maybeItemKey.isPresent()) {
            List<ImrtItem> imrtItems = imrtItemRepository.findAllByAssociatedStimulusId(stimulus.getId());
            stimulusLinkRepository.save(
                    imrtItems.stream().map(imrtItem -> new StimulusLink(imrtItem, savedStimulus, imrtItem.getUpdatedBy()))
                    .collect(Collectors.toList()));
        }
    }
}
