package org.opentestsystem.ap.imrt.iis.repository.impl;


import org.opentestsystem.ap.common.model.ValidationResults;
import org.opentestsystem.ap.imrt.common.service.OperationalEventService;
import org.opentestsystem.ap.imrt.iis.config.ItemIngestServiceProperties;
import org.opentestsystem.ap.imrt.iis.repository.ItemTabulatorRepository;
import org.slf4j.Logger;
import org.slf4j.LoggerFactory;
import org.springframework.boot.web.client.RestTemplateBuilder;
import org.springframework.http.ResponseEntity;
import org.springframework.stereotype.Repository;
import org.springframework.web.client.RestTemplate;
import org.springframework.web.util.UriComponentsBuilder;

import java.net.URI;
import java.util.Optional;

@Repository
public class ItemTabulatorRepositoryImpl implements ItemTabulatorRepository {
    private static final Logger LOG = LoggerFactory.getLogger(ItemTabulatorRepositoryImpl.class);
    private final OperationalEventService operationalEventService;
    private final RestTemplate restTemplate;
    private final ItemIngestServiceProperties itemIngestServiceProperties;

    public ItemTabulatorRepositoryImpl(final OperationalEventService operationalEventService,
                                       final RestTemplateBuilder restTemplateBuilder,
                                       final ItemIngestServiceProperties itemIngestServiceProperties) {
        this.operationalEventService = operationalEventService;
        this.restTemplate = restTemplateBuilder.build();
        this.itemIngestServiceProperties = itemIngestServiceProperties;
    }

    @Override
    public Optional<ValidationResults> getValidationResults(final int itemId) {
        final URI url = UriComponentsBuilder
                .fromHttpUrl(itemIngestServiceProperties.getItemValidationServiceUrl())
                .pathSegment("api/v1/validate")
                .pathSegment("{itemId}")
                .buildAndExpand(itemId)
                .toUri();

        ResponseEntity<ValidationResults> validationResults = restTemplate.getForEntity(url, ValidationResults.class);

        if (!validationResults.getStatusCode().is2xxSuccessful()) {
            operationalEventService.error(LOG, null, "Could not retrieve validation errors for item id " + itemId);
            return Optional.empty();
        }

        return Optional.of(validationResults.getBody());
    }
}
